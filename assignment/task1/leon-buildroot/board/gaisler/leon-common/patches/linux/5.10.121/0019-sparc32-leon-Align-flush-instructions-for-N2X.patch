From 02af02478182010c3a90bfd270a3c167fb610d37 Mon Sep 17 00:00:00 2001
From: Andreas Larsson <andreas@gaisler.com>
Date: Wed, 5 Apr 2017 15:42:18 +0200
Subject: [PATCH 19/28] sparc32: leon: Align flush instructions for N2X

Signed-off-by: Andreas Larsson <andreas@gaisler.com>
---
 arch/sparc/include/asm/cacheflush.h | 2 +-
 arch/sparc/mm/leon_mm.c             | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/sparc/include/asm/cacheflush.h b/arch/sparc/include/asm/cacheflush.h
index 881ac76eab93..a887f90c0006 100644
--- a/arch/sparc/include/asm/cacheflush.h
+++ b/arch/sparc/include/asm/cacheflush.h
@@ -3,7 +3,7 @@
 #define ___ASM_SPARC_CACHEFLUSH_H
 
 /* flush addr - to allow use of self-modifying code */
-#define flushi(addr)	__asm__ __volatile__ ("flush %0" : : "r" (addr) : "memory")
+#define flushi(addr)	__asm__ __volatile__ (".align 32\nflush %0\n.align 32\n" : : "r" (addr) : "memory")
 
 #if defined(__sparc__) && defined(__arch64__)
 #include <asm/cacheflush_64.h>
diff --git a/arch/sparc/mm/leon_mm.c b/arch/sparc/mm/leon_mm.c
index d894a57a6ab3..f8ac99759ed3 100644
--- a/arch/sparc/mm/leon_mm.c
+++ b/arch/sparc/mm/leon_mm.c
@@ -183,7 +183,7 @@ unsigned long leon_swprobe(unsigned long vaddr, unsigned long *paddr)
 
 void leon_flush_icache_all(void)
 {
-	__asm__ __volatile__(" flush ");	/*iflush*/
+	__asm__ __volatile__(".align 32\nflush\n.align 32\n");	/*iflush*/
 }
 
 void leon_flush_dcache_all(void)
@@ -201,7 +201,7 @@ void leon_flush_pcache_all(struct vm_area_struct *vma, unsigned long page)
 
 void leon_flush_cache_all(void)
 {
-	__asm__ __volatile__(" flush ");	/*iflush*/
+	__asm__ __volatile__(".align 32\nflush\n.align 32\n");	/*iflush*/
 	__asm__ __volatile__("sta %%g0, [%%g0] %0\n\t" : :
 			     "i"(ASI_LEON_DFLUSH) : "memory");
 }
-- 
2.17.1

