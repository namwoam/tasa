<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Chapter 18. Adding new packages to Buildroot</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="home" href="index.html" title="The Buildroot user manual" /><link rel="up" href="pt03.html" title="Part III. Developer guide" /><link rel="prev" href="ch17.html" title="Chapter 17. Adding support for a particular board" /><link rel="next" href="ch19.html" title="Chapter 19. Patching a package" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="ch17.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch19.html">Next</a></td></tr></table><hr /></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="adding-packages"></a>Chapter 18. Adding new packages to Buildroot</h2></div></div></div><p>This section covers how new packages (userspace libraries or
applications) can be integrated into Buildroot. It also shows how
existing packages are integrated, which is needed for fixing issues or
tuning their configuration.</p><p>When you add a new package, be sure to test it in various conditions
(see <a class="xref" href="ch18.html#testing-package" title="18.25.3. How to test your package">Section 18.25.3, “How to test your package”</a>) and also check it for coding style (see
<a class="xref" href="ch18.html#check-package" title="18.25.2. How to check the coding style">Section 18.25.2, “How to check the coding style”</a>).</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_package_directory"></a>18.1. Package directory</h2></div></div></div><p>First of all, create a directory under the <code class="literal">package</code> directory for
your software, for example <code class="literal">libfoo</code>.</p><p>Some packages have been grouped by topic in a sub-directory:
<code class="literal">x11r7</code>, <code class="literal">qt5</code> and <code class="literal">gstreamer</code>. If your package fits in
one of these categories, then create your package directory in these.
New subdirectories are discouraged, however.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_config_files"></a>18.2. Config files</h2></div></div></div><p>For the package to be displayed in the configuration tool, you need to
create a Config file in your package directory. There are two types:
<code class="literal">Config.in</code> and <code class="literal">Config.in.host</code>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_literal_config_in_literal_file"></a>18.2.1. <code class="literal">Config.in</code> file</h3></div></div></div><p>For packages used on the target, create a file named <code class="literal">Config.in</code>. This
file will contain the option descriptions related to our <code class="literal">libfoo</code> software
that will be used and displayed in the configuration tool. It should basically
contain:</p><pre class="screen">config BR2_PACKAGE_LIBFOO
        bool "libfoo"
        help
          This is a comment that explains what libfoo is. The help text
          should be wrapped.

          http://foosoftware.org/libfoo/</pre><p>The <code class="literal">bool</code> line, <code class="literal">help</code> line and other metadata information about the
configuration option must be indented with one tab. The help text
itself should be indented with one tab and two spaces, lines should
be wrapped to fit 72 columns, where tab counts for 8, so 62 characters
in the text itself. The help text must mention the upstream URL of the
project after an empty line.</p><p>As a convention specific to Buildroot, the ordering of the attributes
is as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The type of option: <code class="literal">bool</code>, <code class="literal">string</code>… with the prompt
</li><li class="listitem">
If needed, the <code class="literal">default</code> value(s)
</li><li class="listitem">
Any dependencies on the target in <code class="literal">depends on</code> form
</li><li class="listitem">
Any dependencies on the toolchain in <code class="literal">depends on</code> form
</li><li class="listitem">
Any dependencies on other packages in <code class="literal">depends on</code> form
</li><li class="listitem">
Any dependency of the <code class="literal">select</code> form
</li><li class="listitem">
The help keyword and help text.
</li></ol></div><p>You can add other sub-options into a <code class="literal">if BR2_PACKAGE_LIBFOO…endif</code>
statement to configure particular things in your software. You can look at
examples in other packages. The syntax of the <code class="literal">Config.in</code> file is the same
as the one for the kernel Kconfig file. The documentation for this syntax is
available at <a class="ulink" href="http://kernel.org/doc/Documentation/kbuild/kconfig-language.txt" target="_top">http://kernel.org/doc/Documentation/kbuild/kconfig-language.txt</a></p><p>Finally you have to add your new <code class="literal">libfoo/Config.in</code> to
<code class="literal">package/Config.in</code> (or in a category subdirectory if you decided to
put your package in one of the existing categories). The files
included there are <span class="emphasis"><em>sorted alphabetically</em></span> per category and are <span class="emphasis"><em>NOT</em></span>
supposed to contain anything but the <span class="emphasis"><em>bare</em></span> name of the package.</p><pre class="screen">source "package/libfoo/Config.in"</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_literal_config_in_host_literal_file"></a>18.2.2. <code class="literal">Config.in.host</code> file</h3></div></div></div><p>Some packages also need to be built for the host system. There are two
options here:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The host package is only required to satisfy build-time
  dependencies of one or more target packages. In this case, add
  <code class="literal">host-foo</code> to the target package’s <code class="literal">BAR_DEPENDENCIES</code> variable. No
  <code class="literal">Config.in.host</code> file should be created.
</li><li class="listitem"><p class="simpara">
The host package should be explicitly selectable by the user from
  the configuration menu. In this case, create a <code class="literal">Config.in.host</code> file
  for that host package:
</p><pre class="screen">config BR2_PACKAGE_HOST_FOO
        bool "host foo"
        help
          This is a comment that explains what foo for the host is.

          http://foosoftware.org/foo/</pre><p class="simpara">The same coding style and options as for the <code class="literal">Config.in</code> file are valid.</p><p class="simpara">Finally you have to add your new <code class="literal">libfoo/Config.in.host</code> to
<code class="literal">package/Config.in.host</code>. The files included there are <span class="emphasis"><em>sorted alphabetically</em></span>
and are <span class="emphasis"><em>NOT</em></span> supposed to contain anything but the <span class="emphasis"><em>bare</em></span> name of the package.</p><pre class="screen">source "package/foo/Config.in.host"</pre><p class="simpara">The host package will then be available from the <code class="literal">Host utilities</code> menu.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="depends-on-vs-select"></a>18.2.3. Choosing <code class="literal">depends on</code> or <code class="literal">select</code></h3></div></div></div><p>The <code class="literal">Config.in</code> file of your package must also ensure that
dependencies are enabled. Typically, Buildroot uses the following
rules:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Use a <code class="literal">select</code> type of dependency for dependencies on
  libraries. These dependencies are generally not obvious and it
  therefore make sense to have the kconfig system ensure that the
  dependencies are selected. For example, the <span class="emphasis"><em>libgtk2</em></span> package uses
  <code class="literal">select BR2_PACKAGE_LIBGLIB2</code> to make sure this library is also
  enabled.
  The <code class="literal">select</code> keyword expresses the dependency with a backward
  semantic.
</li><li class="listitem">
Use a <code class="literal">depends on</code> type of dependency when the user really needs to
  be aware of the dependency. Typically, Buildroot uses this type of
  dependency for dependencies on target architecture, MMU support and
  toolchain options (see <a class="xref" href="ch18.html#dependencies-target-toolchain-options" title="18.2.4. Dependencies on target and toolchain options">Section 18.2.4, “Dependencies on target and toolchain options”</a>),
  or for dependencies on "big" things, such as the X.org system.
  The <code class="literal">depends on</code> keyword expresses the dependency with a forward
  semantic.
</li></ul></div><p><strong>Note. </strong>The current problem with the <span class="emphasis"><em>kconfig</em></span> language is that these two
dependency semantics are not internally linked. Therefore, it may be
possible to select a package, whom one of its dependencies/requirement
is not met.</p><p>An example illustrates both the usage of <code class="literal">select</code> and <code class="literal">depends on</code>.</p><pre class="screen">config BR2_PACKAGE_RRDTOOL
        bool "rrdtool"
        depends on BR2_USE_WCHAR
        select BR2_PACKAGE_FREETYPE
        select BR2_PACKAGE_LIBART
        select BR2_PACKAGE_LIBPNG
        select BR2_PACKAGE_ZLIB
        help
          RRDtool is the OpenSource industry standard, high performance
          data logging and graphing system for time series data.

          http://oss.oetiker.ch/rrdtool/

comment "rrdtool needs a toolchain w/ wchar"
        depends on !BR2_USE_WCHAR</pre><p>Note that these two dependency types are only transitive with the
dependencies of the same kind.</p><p>This means, in the following example:</p><pre class="screen">config BR2_PACKAGE_A
        bool "Package A"

config BR2_PACKAGE_B
        bool "Package B"
        depends on BR2_PACKAGE_A

config BR2_PACKAGE_C
        bool "Package C"
        depends on BR2_PACKAGE_B

config BR2_PACKAGE_D
        bool "Package D"
        select BR2_PACKAGE_B

config BR2_PACKAGE_E
        bool "Package E"
        select BR2_PACKAGE_D</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Selecting <code class="literal">Package C</code> will be visible if <code class="literal">Package B</code> has been
  selected, which in turn is only visible if <code class="literal">Package A</code> has been
  selected.
</li><li class="listitem">
Selecting <code class="literal">Package E</code> will select <code class="literal">Package D</code>, which will select
  <code class="literal">Package B</code>, it will not check for the dependencies of <code class="literal">Package B</code>,
  so it will not select <code class="literal">Package A</code>.
</li><li class="listitem">
Since <code class="literal">Package B</code> is selected but <code class="literal">Package A</code> is not, this violates
  the dependency of <code class="literal">Package B</code> on <code class="literal">Package A</code>. Therefore, in such a
  situation, the transitive dependency has to be added explicitly:
</li></ul></div><pre class="screen">config BR2_PACKAGE_D
        bool "Package D"
        depends on BR2_PACKAGE_A
        select BR2_PACKAGE_B

config BR2_PACKAGE_E
        bool "Package E"
        depends on BR2_PACKAGE_A
        select BR2_PACKAGE_D</pre><p>Overall, for package library dependencies, <code class="literal">select</code> should be
preferred.</p><p>Note that such dependencies will ensure that the dependency option
is also enabled, but not necessarily built before your package. To do
so, the dependency also needs to be expressed in the <code class="literal">.mk</code> file of the
package.</p><p>Further formatting details: see <a class="link" href="ch16.html#writing-rules-config-in" title="16.1. Config.in file">the
coding style</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="dependencies-target-toolchain-options"></a>18.2.4. Dependencies on target and toolchain options</h3></div></div></div><p>Many packages depend on certain options of the toolchain: the choice of
C library, C++ support, thread support, RPC support, wchar support,
or dynamic library support. Some packages can only be built on certain
target architectures, or if an MMU is available in the processor.</p><p>These dependencies have to be expressed with the appropriate <span class="emphasis"><em>depends
on</em></span> statements in the Config.in file. Additionally, for dependencies on
toolchain options, a <code class="literal">comment</code> should be displayed when the option is
not enabled, so that the user knows why the package is not available.
Dependencies on target architecture or MMU support should not be
made visible in a comment: since it is unlikely that the user can
freely choose another target, it makes little sense to show these
dependencies explicitly.</p><p>The <code class="literal">comment</code> should only be visible if the <code class="literal">config</code> option itself would
be visible when the toolchain option dependencies are met. This means
that all other dependencies of the package (including dependencies on
target architecture and MMU support) have to be repeated on the
<code class="literal">comment</code> definition. To keep it clear, the <code class="literal">depends on</code> statement for
these non-toolchain option should be kept separate from the <code class="literal">depends on</code>
statement for the toolchain options.
If there is a dependency on a config option in that same file (typically
the main package) it is preferable to have a global <code class="literal">if … endif</code>
construct rather than repeating the <code class="literal">depends on</code> statement on the
comment and other config options.</p><p>The general format of a dependency <code class="literal">comment</code> for package foo is:</p><pre class="screen">foo needs a toolchain w/ featA, featB, featC</pre><p>for example:</p><pre class="screen">mpd needs a toolchain w/ C++, threads, wchar</pre><p>or</p><pre class="screen">crda needs a toolchain w/ threads</pre><p>Note that this text is kept brief on purpose, so that it will fit on a
80-character terminal.</p><p>The rest of this section enumerates the different target and toolchain
options, the corresponding config symbols to depend on, and the text to
use in the comment.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Target architecture
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_powerpc</code>, <code class="literal">BR2_mips</code>, … (see <code class="literal">arch/Config.in</code>)
</li><li class="listitem">
Comment string: no comment to be added
</li></ul></div></li><li class="listitem"><p class="simpara">
MMU support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_USE_MMU</code>
</li><li class="listitem">
Comment string: no comment to be added
</li></ul></div></li><li class="listitem"><p class="simpara">
Gcc <code class="literal"><span class="emphasis"><em>_sync</em></span>*</code> built-ins used for atomic operations. They are
  available in variants operating on 1 byte, 2 bytes, 4 bytes and 8
  bytes. Since different architectures support atomic operations on
  different sizes, one dependency symbol is available for each size:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_SYNC_1</code> for 1 byte,
   <code class="literal">BR2_TOOLCHAIN_HAS_SYNC_2</code> for 2 bytes,
   <code class="literal">BR2_TOOLCHAIN_HAS_SYNC_4</code> for 4 bytes, <code class="literal">BR2_TOOLCHAIN_HAS_SYNC_8</code>
   for 8 bytes.
</li><li class="listitem">
Comment string: no comment to be added
</li></ul></div></li><li class="listitem"><p class="simpara">
Gcc <code class="literal"><span class="emphasis"><em>_atomic</em></span>*</code> built-ins used for atomic operations.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_ATOMIC</code>.
</li><li class="listitem">
Comment string: no comment to be added
</li></ul></div></li><li class="listitem"><p class="simpara">
Kernel headers
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HEADERS_AT_LEAST_X_Y</code>, (replace
   <code class="literal">X_Y</code> with the proper version, see <code class="literal">toolchain/Config.in</code>)
</li><li class="listitem">
Comment string: <code class="literal">headers &gt;= X.Y</code> and/or <code class="literal">headers &lt;= X.Y</code> (replace
   <code class="literal">X.Y</code> with the proper version)
</li></ul></div></li><li class="listitem"><p class="simpara">
GCC version
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_GCC_AT_LEAST_X_Y</code>, (replace
   <code class="literal">X_Y</code> with the proper version, see <code class="literal">toolchain/Config.in</code>)
</li><li class="listitem">
Comment string: <code class="literal">gcc &gt;= X.Y</code> and/or <code class="literal">gcc &lt;= X.Y</code> (replace
   <code class="literal">X.Y</code> with the proper version)
</li></ul></div></li><li class="listitem"><p class="simpara">
Host GCC version
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_HOST_GCC_AT_LEAST_X_Y</code>, (replace
   <code class="literal">X_Y</code> with the proper version, see <code class="literal">Config.in</code>)
</li><li class="listitem">
Comment string: no comment to be added
</li><li class="listitem">
Note that it is usually not the package itself that has a minimum
   host GCC version, but rather a host-package on which it depends.
</li></ul></div></li><li class="listitem"><p class="simpara">
C library
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_USES_GLIBC</code>,
   <code class="literal">BR2_TOOLCHAIN_USES_MUSL</code>, <code class="literal">BR2_TOOLCHAIN_USES_UCLIBC</code>
</li><li class="listitem">
Comment string: for the C library, a slightly different comment text
   is used: <code class="literal">foo needs a glibc toolchain</code>, or <code class="literal">foo needs a glibc
   toolchain w/ C++</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
C++ support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_INSTALL_LIBSTDCPP</code>
</li><li class="listitem">
Comment string: <code class="literal">C++</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
D support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_DLANG</code>
</li><li class="listitem">
Comment string: <code class="literal">Dlang</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Fortran support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_FORTRAN</code>
</li><li class="listitem">
Comment string: <code class="literal">fortran</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
thread support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_THREADS</code>
</li><li class="listitem">
Comment string: <code class="literal">threads</code> (unless <code class="literal">BR2_TOOLCHAIN_HAS_THREADS_NPTL</code>
   is also needed, in which case, specifying only <code class="literal">NPTL</code> is sufficient)
</li></ul></div></li><li class="listitem"><p class="simpara">
NPTL thread support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_THREADS_NPTL</code>
</li><li class="listitem">
Comment string: <code class="literal">NPTL</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
RPC support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_TOOLCHAIN_HAS_NATIVE_RPC</code>
</li><li class="listitem">
Comment string: <code class="literal">RPC</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
wchar support
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">BR2_USE_WCHAR</code>
</li><li class="listitem">
Comment string: <code class="literal">wchar</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
dynamic library
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Dependency symbol: <code class="literal">!BR2_STATIC_LIBS</code>
</li><li class="listitem">
Comment string: <code class="literal">dynamic library</code>
</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_dependencies_on_a_linux_kernel_built_by_buildroot"></a>18.2.5. Dependencies on a Linux kernel built by buildroot</h3></div></div></div><p>Some packages need a Linux kernel to be built by buildroot. These are
typically kernel modules or firmware. A comment should be added in the
Config.in file to express this dependency, similar to dependencies on
toolchain options. The general format is:</p><pre class="screen">foo needs a Linux kernel to be built</pre><p>If there is a dependency on both toolchain options and the Linux
kernel, use this format:</p><pre class="screen">foo needs a toolchain w/ featA, featB, featC and a Linux kernel to be built</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_dependencies_on_udev_dev_management"></a>18.2.6. Dependencies on udev /dev management</h3></div></div></div><p>If a package needs udev /dev management, it should depend on symbol
<code class="literal">BR2_PACKAGE_HAS_UDEV</code>, and the following comment should be added:</p><pre class="screen">foo needs udev /dev management</pre><p>If there is a dependency on both toolchain options and udev /dev
management, use this format:</p><pre class="screen">foo needs udev /dev management and a toolchain w/ featA, featB, featC</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_dependencies_on_features_provided_by_virtual_packages"></a>18.2.7. Dependencies on features provided by virtual packages</h3></div></div></div><p>Some features can be provided by more than one package, such as the
openGL libraries.</p><p>See <a class="xref" href="ch18.html#virtual-package-tutorial">Section 18.12, “Infrastructure for virtual packages”</a> for more on the virtual packages.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_the_literal_mk_literal_file"></a>18.3. The <code class="literal">.mk</code> file</h2></div></div></div><p><a id="adding-packages-mk"></a>Finally, here’s the hardest part. Create a file named <code class="literal">libfoo.mk</code>. It
describes how the package should be downloaded, configured, built,
installed, etc.</p><p>Depending on the package type, the <code class="literal">.mk</code> file must be written in a
different way, using different infrastructures:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Makefiles for generic packages</strong></span> (not using autotools or CMake):
  These are based on an infrastructure similar to the one used for
  autotools-based packages, but require a little more work from the
  developer. They specify what should be done for the configuration,
  compilation and installation of the package. This
  infrastructure must be used for all packages that do not use the
  autotools as their build system. In the future, other specialized
  infrastructures might be written for other build systems. We cover
  them through in a <a class="link" href="ch18.html#generic-package-tutorial" title="18.6.1. generic-package tutorial">tutorial</a> and a
  <a class="link" href="ch18.html#generic-package-reference" title="18.6.2. generic-package reference">reference</a>.
</li><li class="listitem">
<span class="strong"><strong>Makefiles for autotools-based software</strong></span> (autoconf, automake, etc.):
  We provide a dedicated infrastructure for such packages, since
  autotools is a very common build system. This infrastructure <span class="emphasis"><em>must</em></span>
  be used for new packages that rely on the autotools as their build
  system. We cover them through a <a class="link" href="ch18.html#autotools-package-tutorial" title="18.7.1. autotools-package tutorial">tutorial</a>
  and <a class="link" href="ch18.html#autotools-package-reference" title="18.7.2. autotools-package reference">reference</a>.
</li><li class="listitem">
<span class="strong"><strong>Makefiles for cmake-based software</strong></span>: We provide a dedicated
   infrastructure for such packages, as CMake is a more and more
   commonly used build system and has a standardized behaviour. This
   infrastructure <span class="emphasis"><em>must</em></span> be used for new packages that rely on
   CMake. We cover them through a <a class="link" href="ch18.html#cmake-package-tutorial" title="18.8.1. cmake-package tutorial">tutorial</a>
   and <a class="link" href="ch18.html#cmake-package-reference" title="18.8.2. cmake-package reference">reference</a>.
</li><li class="listitem">
<span class="strong"><strong>Makefiles for Python modules</strong></span>: We have a dedicated infrastructure
   for Python modules that use either the <code class="literal">distutils</code> or the
   <code class="literal">setuptools</code> mechanism. We cover them through a
   <a class="link" href="ch18.html#python-package-tutorial" title="18.9.1. python-package tutorial">tutorial</a> and a
   <a class="link" href="ch18.html#python-package-reference" title="18.9.2. python-package reference">reference</a>.
</li><li class="listitem">
<span class="strong"><strong>Makefiles for Lua modules</strong></span>: We have a dedicated infrastructure for
   Lua modules available through the LuaRocks web site. We cover them
   through a <a class="link" href="ch18.html#luarocks-package-tutorial" title="18.10.1. luarocks-package tutorial">tutorial</a> and a
   <a class="link" href="ch18.html#luarocks-package-reference" title="18.10.2. luarocks-package reference">reference</a>.
</li></ul></div><p>Further formatting details: see <a class="link" href="ch16.html#writing-rules-mk" title="16.2. The .mk file">the writing
rules</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="adding-packages-hash"></a>18.4. The <code class="literal">.hash</code> file</h2></div></div></div><p>When possible, you must add a third file, named <code class="literal">libfoo.hash</code>, that
contains the hashes of the downloaded files for the <code class="literal">libfoo</code>
package. The only reason for not adding a <code class="literal">.hash</code> file is when hash
checking is not possible due to how the package is downloaded.</p><p>When a package has a version selection choice, then the hash file may be
stored in a subdirectory named after the version, e.g.
<code class="literal">package/libfoo/1.2.3/libfoo.hash</code>. This is especially important if the
different versions have different licensing terms, but they are stored
in the same file. Otherwise, the hash file should stay in the package’s
directory.</p><p>The hashes stored in that file are used to validate the integrity of the
downloaded files and of the license files.</p><p>The format of this file is one line for each file for which to check the
hash, each line with the following three fields separated by two spaces:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
the type of hash, one of:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">md5</code>, <code class="literal">sha1</code>, <code class="literal">sha224</code>, <code class="literal">sha256</code>, <code class="literal">sha384</code>, <code class="literal">sha512</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
the hash of the file:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
for <code class="literal">md5</code>, 32 hexadecimal characters
</li><li class="listitem">
for <code class="literal">sha1</code>, 40 hexadecimal characters
</li><li class="listitem">
for <code class="literal">sha224</code>, 56 hexadecimal characters
</li><li class="listitem">
for <code class="literal">sha256</code>, 64 hexadecimal characters
</li><li class="listitem">
for <code class="literal">sha384</code>, 96 hexadecimal characters
</li><li class="listitem">
for <code class="literal">sha512</code>, 128 hexadecimal characters
</li></ul></div></li><li class="listitem"><p class="simpara">
the name of the file:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
for a source archive: the basename of the file, without any directory
   component,
</li><li class="listitem">
for a license file: the path as it appears in <code class="literal">FOO_LICENSE_FILES</code>.
</li></ul></div></li></ul></div><p>Lines starting with a <code class="literal">#</code> sign are considered comments, and ignored. Empty
lines are ignored.</p><p>There can be more than one hash for a single file, each on its own line. In
this case, all hashes must match.</p><p><strong>Note. </strong>Ideally, the hashes stored in this file should match the hashes published by
upstream, e.g. on their website, in the e-mail announcement… If upstream
provides more than one type of hash (e.g. <code class="literal">sha1</code> and <code class="literal">sha512</code>), then it is
best to add all those hashes in the <code class="literal">.hash</code> file. If upstream does not
provide any hash, or only provides an <code class="literal">md5</code> hash, then compute at least one
strong hash yourself (preferably <code class="literal">sha256</code>, but not <code class="literal">md5</code>), and mention
this in a comment line above the hashes.</p><p><strong>Note. </strong>The hashes for license files are used to detect a license change when a
package version is bumped. The hashes are checked during the make legal-info
target run. For a package with multiple versions (like Qt5),
create the hash file in a subdirectory <code class="literal">&lt;packageversion&gt;</code> of that package
(see also <a class="xref" href="ch19.html#patch-apply-order" title="19.2. How patches are applied">Section 19.2, “How patches are applied”</a>).</p><p>The example below defines a <code class="literal">sha1</code> and a <code class="literal">sha256</code> published by upstream for
the main <code class="literal">libfoo-1.2.3.tar.bz2</code> tarball, an <code class="literal">md5</code> from upstream and a
locally-computed <code class="literal">sha256</code> hashes for a binary blob, a <code class="literal">sha256</code> for a
downloaded patch, and an archive with no hash:</p><pre class="screen"># Hashes from: http://www.foosoftware.org/download/libfoo-1.2.3.tar.bz2.{sha1,sha256}:
sha1  486fb55c3efa71148fe07895fd713ea3a5ae343a  libfoo-1.2.3.tar.bz2
sha256  efc8103cc3bcb06bda6a781532d12701eb081ad83e8f90004b39ab81b65d4369  libfoo-1.2.3.tar.bz2

# md5 from: http://www.foosoftware.org/download/libfoo-1.2.3.tar.bz2.md5, sha256 locally computed:
md5  2d608f3c318c6b7557d551a5a09314f03452f1a1  libfoo-data.bin
sha256  01ba4719c80b6fe911b091a7c05124b64eeece964e09c058ef8f9805daca546b  libfoo-data.bin

# Locally computed:
sha256  ff52101fb90bbfc3fe9475e425688c660f46216d7e751c4bbdb1dc85cdccacb9  libfoo-fix-blabla.patch

# Hash for license files:
sha256  a45a845012742796534f7e91fe623262ccfb99460a2bd04015bd28d66fba95b8  COPYING
sha256  01b1f9f2c8ee648a7a596a1abe8aa4ed7899b1c9e5551bda06da6e422b04aa55  doc/COPYING.LGPL</pre><p>If the <code class="literal">.hash</code> file is present, and it contains one or more hashes for a
downloaded file, the hash(es) computed by Buildroot (after download) must
match the hash(es) stored in the <code class="literal">.hash</code> file. If one or more hashes do
not match, Buildroot considers this an error, deletes the downloaded file,
and aborts.</p><p>If the <code class="literal">.hash</code> file is present, but it does not contain a hash for a
downloaded file, Buildroot considers this an error and aborts. However,
the downloaded file is left in the download directory since this
typically indicates that the <code class="literal">.hash</code> file is wrong but the downloaded
file is probably OK.</p><p>Hashes are currently checked for files fetched from http/ftp servers,
Git repositories, files copied using scp and local files. Hashes are
not checked for other version control systems (such as Subversion,
CVS, etc.) because Buildroot currently does not generate reproducible
tarballs when source code is fetched from such version control
systems.</p><p>Hashes should only be added in <code class="literal">.hash</code> files for files that are
guaranteed to be stable. For example, patches auto-generated by Github
are not guaranteed to be stable, and therefore their hashes can change
over time. Such patches should not be downloaded, and instead be added
locally to the package folder.</p><p>If the <code class="literal">.hash</code> file is missing, then no check is done at all.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="adding-packages-start-script"></a>18.5. The <code class="literal">SNNfoo</code> start script</h2></div></div></div><p>Packages that provide a system daemon usually need to be started somehow
at boot.  Buildroot comes with support for several init systems, some
are considered tier one (see <a class="xref" href="ch06.html#init-system" title="6.3. init system">Section 6.3, “init system”</a>), while others are also
available but do not have the same level of integration.  Ideally, all
packages providing a system daemon should provide a start script for
BusyBox/SysV init and a systemd unit file.</p><p>For consistency, the start script must follow the style and composition
as shown in the reference: <code class="literal">package/busybox/S01syslogd</code>. An annotated
example of this style is shown below. There is no specific coding style
for systemd unit files, but if a package comes with its own unit file,
that is preferred over a buildroot specific one, if it is compatible
with buildroot.</p><p>The name of the start script is composed of the <code class="literal">SNN</code> and the daemon
name.  The <code class="literal">NN</code> is the start order number which needs to be carefully
chosen.  For example, a program that requires networking to be up should
not start before <code class="literal">S40network</code>.  The scripts are started in alphabetical
order, so <code class="literal">S01syslogd</code> starts before <code class="literal">S01watchdogd</code>, and <code class="literal">S02sysctl</code>
start thereafter.</p><pre class="screen">01: #!/bin/sh
02:
03: DAEMON="syslogd"
04: PIDFILE="/var/run/$DAEMON.pid"
05:
06: SYSLOGD_ARGS=""
07:
08: # shellcheck source=/dev/null
09: [ -r "/etc/default/$DAEMON" ] &amp;&amp; . "/etc/default/$DAEMON"
10:
11: # BusyBox' syslogd does not create a pidfile, so pass "-n" in the command line
12: # and use "-m" to instruct start-stop-daemon to create one.
13: start() {
14:     printf 'Starting %s: ' "$DAEMON"
15:     # shellcheck disable=SC2086 # we need the word splitting
16:     start-stop-daemon -b -m -S -q -p "$PIDFILE" -x "/sbin/$DAEMON" \
17:             -- -n $SYSLOGD_ARGS
18:     status=$?
19:     if [ "$status" -eq 0 ]; then
20:             echo "OK"
21:     else
22:             echo "FAIL"
23:     fi
24:     return "$status"
25: }
26:
27: stop() {
28:     printf 'Stopping %s: ' "$DAEMON"
29:     start-stop-daemon -K -q -p "$PIDFILE"
30:     status=$?
31:     if [ "$status" -eq 0 ]; then
32:             rm -f "$PIDFILE"
33:             echo "OK"
34:     else
35:             echo "FAIL"
36:     fi
37:     return "$status"
38: }
39:
40: restart() {
41:     stop
42:     sleep 1
43:     start
44: }
45:
46: case "$1" in
47:     start|stop|restart)
48:             "$1";;
49:     reload)
50:             # Restart, since there is no true "reload" feature.
51:             restart;;
52:     *)
53:             echo "Usage: $0 {start|stop|restart|reload}"
54:             exit 1
55: esac</pre><p><span class="strong"><strong>Note:</strong></span> programs that support reloading their configuration in some
fashion (<code class="literal">SIGHUP</code>) should provide a <code class="literal">reload()</code> function similar to
<code class="literal">stop()</code>.  The <code class="literal">start-stop-daemon</code> supports <code class="literal">-K -s HUP</code> for this.
It is recommended to always append <code class="literal">-x "/sbin/$DAEMON"</code> to all the
<code class="literal">start-stop-daemon</code> commands to ensure signals are set to a PID that
matches <code class="literal">$DAEMON</code>.</p><p>Both start scripts and unit files can source command line arguments from
<code class="literal">/etc/default/foo</code>, in general, if such a file does not exist it should
not block the start of the daemon, unless there is some site specirfic
command line argument the daemon requires to start.  For start scripts a
<code class="literal">FOO_ARGS="-s -o -m -e -args"</code> can be defined to a default value in and
the user can override this from <code class="literal">/etc/default/foo</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_packages_with_specific_build_systems"></a>18.6. Infrastructure for packages with specific build systems</h2></div></div></div><p>By <span class="emphasis"><em>packages with specific build systems</em></span> we mean all the packages
whose build system is not one of the standard ones, such as
<span class="emphasis"><em>autotools</em></span> or <span class="emphasis"><em>CMake</em></span>. This typically includes packages whose build
system is based on hand-written Makefiles or shell scripts.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="generic-package-tutorial"></a>18.6.1. <code class="literal">generic-package</code> tutorial</h3></div></div></div><pre class="screen">01: ################################################################################
02: #
03: # libfoo
04: #
05: ################################################################################
06:
07: LIBFOO_VERSION = 1.0
08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz
09: LIBFOO_SITE = http://www.foosoftware.org/download
10: LIBFOO_LICENSE = GPL-3.0+
11: LIBFOO_LICENSE_FILES = COPYING
12: LIBFOO_INSTALL_STAGING = YES
13: LIBFOO_CONFIG_SCRIPTS = libfoo-config
14: LIBFOO_DEPENDENCIES = host-libaaa libbbb
15:
16: define LIBFOO_BUILD_CMDS
17:     $(MAKE) $(TARGET_CONFIGURE_OPTS) -C $(@D) all
18: endef
19:
20: define LIBFOO_INSTALL_STAGING_CMDS
21:     $(INSTALL) -D -m 0755 $(@D)/libfoo.a $(STAGING_DIR)/usr/lib/libfoo.a
22:     $(INSTALL) -D -m 0644 $(@D)/foo.h $(STAGING_DIR)/usr/include/foo.h
23:     $(INSTALL) -D -m 0755 $(@D)/libfoo.so* $(STAGING_DIR)/usr/lib
24: endef
25:
26: define LIBFOO_INSTALL_TARGET_CMDS
27:     $(INSTALL) -D -m 0755 $(@D)/libfoo.so* $(TARGET_DIR)/usr/lib
28:     $(INSTALL) -d -m 0755 $(TARGET_DIR)/etc/foo.d
29: endef
30:
31: define LIBFOO_USERS
32:     foo -1 libfoo -1 * - - - LibFoo daemon
33: endef
34:
35: define LIBFOO_DEVICES
36:     /dev/foo c 666 0 0 42 0 - - -
37: endef
38:
39: define LIBFOO_PERMISSIONS
40:     /bin/foo f 4755 foo libfoo - - - - -
41: endef
42:
43: $(eval $(generic-package))</pre><p>The Makefile begins on line 7 to 11 with metadata information: the
version of the package (<code class="literal">LIBFOO_VERSION</code>), the name of the
tarball containing the package (<code class="literal">LIBFOO_SOURCE</code>) (xz-ed tarball recommended)
the Internet location at which the tarball can be downloaded from
(<code class="literal">LIBFOO_SITE</code>), the license (<code class="literal">LIBFOO_LICENSE</code>) and file with the
license text (<code class="literal">LIBFOO_LICENSE_FILES</code>). All variables must start with
the same prefix, <code class="literal">LIBFOO_</code> in this case. This prefix is always the
uppercased version of the package name (see below to understand where
the package name is defined).</p><p>On line 12, we specify that this package wants to install something to
the staging space. This is often needed for libraries, since they must
install header files and other development files in the staging space.
This will ensure that the commands listed in the
<code class="literal">LIBFOO_INSTALL_STAGING_CMDS</code> variable will be executed.</p><p>On line 13, we specify that there is some fixing to be done to some
of the <span class="emphasis"><em>libfoo-config</em></span> files that were installed during
<code class="literal">LIBFOO_INSTALL_STAGING_CMDS</code> phase.
These *-config files are executable shell script files that are
located in <span class="emphasis"><em>$(STAGING_DIR)/usr/bin</em></span> directory and are executed
by other 3rd party packages to find out the location and the linking
flags of this particular package.</p><p>The problem is that all these *-config files by default give wrong,
host system linking flags that are unsuitable for cross-compiling.</p><p>For example:    <span class="emphasis"><em>-I/usr/include</em></span> instead of <span class="emphasis"><em>-I$(STAGING_DIR)/usr/include</em></span>
or:             <span class="emphasis"><em>-L/usr/lib</em></span> instead of <span class="emphasis"><em>-L$(STAGING_DIR)/usr/lib</em></span></p><p>So some sed magic is done to these scripts to make them give correct
flags.
The argument to be given to <code class="literal">LIBFOO_CONFIG_SCRIPTS</code> is the file name(s)
of the shell script(s) needing fixing. All these names are relative to
<span class="emphasis"><em>$(STAGING_DIR)/usr/bin</em></span> and if needed multiple names can be given.</p><p>In addition, the scripts listed in <code class="literal">LIBFOO_CONFIG_SCRIPTS</code> are removed
from <code class="literal">$(TARGET_DIR)/usr/bin</code>, since they are not needed on the target.</p><div class="example"><a id="idm3277"></a><p class="title"><strong>Example 18.1. Config script: <span class="emphasis"><em>divine</em></span> package</strong></p><div class="example-contents"><p>Package divine installs shell script <span class="emphasis"><em>$(STAGING_DIR)/usr/bin/divine-config</em></span>.</p><p>So its fixup would be:</p><pre class="screen">DIVINE_CONFIG_SCRIPTS = divine-config</pre></div></div><br class="example-break" /><div class="example"><a id="idm3284"></a><p class="title"><strong>Example 18.2. Config script: <span class="emphasis"><em>imagemagick</em></span> package:</strong></p><div class="example-contents"><p>Package imagemagick installs the following scripts:
<span class="emphasis"><em>$(STAGING_DIR)/usr/bin/{Magick,Magick++,MagickCore,MagickWand,Wand}-config</em></span></p><p>So it’s fixup would be:</p><pre class="screen">IMAGEMAGICK_CONFIG_SCRIPTS = \
   Magick-config Magick++-config \
   MagickCore-config MagickWand-config Wand-config</pre></div></div><br class="example-break" /><p>On line 14, we specify the list of dependencies this package relies
on. These dependencies are listed in terms of lower-case package names,
which can be packages for the target (without the <code class="literal">host-</code>
prefix) or packages for the host (with the <code class="literal">host-</code>) prefix).
Buildroot will ensure that all these packages are built and installed
<span class="emphasis"><em>before</em></span> the current package starts its configuration.</p><p>The rest of the Makefile, lines 16..29, defines what should be done
at the different steps of the package configuration, compilation and
installation.
<code class="literal">LIBFOO_BUILD_CMDS</code> tells what steps should be performed to
build the package. <code class="literal">LIBFOO_INSTALL_STAGING_CMDS</code> tells what
steps should be performed to install the package in the staging space.
<code class="literal">LIBFOO_INSTALL_TARGET_CMDS</code> tells what steps should be
performed to install the package in the target space.</p><p>All these steps rely on the <code class="literal">$(@D)</code> variable, which
contains the directory where the source code of the package has been
extracted.</p><p>On lines 31..33, we define a user that is used by this package (e.g.
to run a daemon as non-root) (<code class="literal">LIBFOO_USERS</code>).</p><p>On line 35..37, we define a device-node file used by this package
(<code class="literal">LIBFOO_DEVICES</code>).</p><p>On line 39..41, we define the permissions to set to specific files
installed by this package (<code class="literal">LIBFOO_PERMISSIONS</code>).</p><p>Finally, on line 43, we call the <code class="literal">generic-package</code> function, which
generates, according to the variables defined previously, all the
Makefile code necessary to make your package working.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="generic-package-reference"></a>18.6.2. <code class="literal">generic-package</code> reference</h3></div></div></div><p>There are two variants of the generic target. The <code class="literal">generic-package</code> macro is
used for packages to be cross-compiled for the target. The
<code class="literal">host-generic-package</code> macro is used for host packages, natively compiled
for the host. It is possible to call both of them in a single <code class="literal">.mk</code>
file: once to create the rules to generate a target
package and once to create the rules to generate a host package:</p><pre class="screen">$(eval $(generic-package))
$(eval $(host-generic-package))</pre><p>This might be useful if the compilation of the target package requires
some tools to be installed on the host. If the package name is
<code class="literal">libfoo</code>, then the name of the package for the target is also
<code class="literal">libfoo</code>, while the name of the package for the host is
<code class="literal">host-libfoo</code>. These names should be used in the DEPENDENCIES
variables of other packages, if they depend on <code class="literal">libfoo</code> or
<code class="literal">host-libfoo</code>.</p><p>The call to the <code class="literal">generic-package</code> and/or <code class="literal">host-generic-package</code> macro
<span class="strong"><strong>must</strong></span> be at the end of the <code class="literal">.mk</code> file, after all variable definitions.
The call to <code class="literal">host-generic-package</code> <span class="strong"><strong>must</strong></span> be after the call to
<code class="literal">generic-package</code>, if any.</p><p>For the target package, the <code class="literal">generic-package</code> uses the variables defined by
the .mk file and prefixed by the uppercased package name:
<code class="literal">LIBFOO_*</code>. <code class="literal">host-generic-package</code> uses the <code class="literal">HOST_LIBFOO_*</code> variables. For
<span class="emphasis"><em>some</em></span> variables, if the <code class="literal">HOST_LIBFOO_</code> prefixed variable doesn’t
exist, the package infrastructure uses the corresponding variable
prefixed by <code class="literal">LIBFOO_</code>. This is done for variables that are likely to
have the same value for both the target and host packages. See below
for details.</p><p>The list of variables that can be set in a <code class="literal">.mk</code> file to give metadata
information is (assuming the package name is <code class="literal">libfoo</code>) :</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
<code class="literal">LIBFOO_VERSION</code>, mandatory, must contain the version of the
  package. Note that if <code class="literal">HOST_LIBFOO_VERSION</code> doesn’t exist, it is
  assumed to be the same as <code class="literal">LIBFOO_VERSION</code>. It can also be a
  revision number or a tag for packages that are fetched directly
  from their version control system. Examples:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
a version for a release tarball: <code class="literal">LIBFOO_VERSION = 0.1.2</code>
</li><li class="listitem">
a sha1 for a git tree: <code class="literal">LIBFOO_VERSION = cb9d6aa9429e838f0e54faa3d455bcbab5eef057</code>
</li><li class="listitem"><p class="simpara">
a tag for a git tree <code class="literal">LIBFOO_VERSION = v0.1.2</code>
</p><p><strong>Note: </strong>Using a branch name as <code class="literal">FOO_VERSION</code> is not supported, because it does
not and can not work as people would expect it should:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
due to local caching, Buildroot will not re-fetch the repository,
     so people who expect to be able to follow the remote repository
     would be quite surprised and disappointed;
</li><li class="listitem">
because two builds can never be perfectly simultaneous, and because
     the remote repository may get new commits on the branch anytime,
     two users, using the same Buildroot tree and building the same
     configuration, may get different source, thus rendering the build
     non reproducible, and people would be quite surprised and
     disappointed.
</li></ol></div></li></ul></div></li><li class="listitem">
<code class="literal">LIBFOO_SOURCE</code> may contain the name of the tarball of the package,
  which Buildroot will use to download the tarball from
  <code class="literal">LIBFOO_SITE</code>. If <code class="literal">HOST_LIBFOO_SOURCE</code> is not specified, it defaults
  to <code class="literal">LIBFOO_SOURCE</code>. If none are specified, then the value is assumed
  to be <code class="literal">libfoo-$(LIBFOO_VERSION).tar.gz</code>.
  Example: <code class="literal">LIBFOO_SOURCE = foobar-$(LIBFOO_VERSION).tar.bz2</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PATCH</code> may contain a space-separated list of patch file
  names, that Buildroot will download and apply to the package source
  code. If an entry contains <code class="literal">://</code>, then Buildroot will assume it is a
  full URL and download the patch from this location. Otherwise,
  Buildroot will assume that the patch should be downloaded from
  <code class="literal">LIBFOO_SITE</code>. If <code class="literal">HOST_LIBFOO_PATCH</code> is not specified, it defaults
  to <code class="literal">LIBFOO_PATCH</code>. Note that patches that are included in Buildroot
  itself use a different mechanism: all files of the form
  <code class="literal">*.patch</code> present in the package directory inside
  Buildroot will be applied to the package after extraction (see
  <a class="link" href="ch19.html" title="Chapter 19. Patching a package">patching a package</a>). Finally, patches listed in
  the <code class="literal">LIBFOO_PATCH</code> variable are applied <span class="emphasis"><em>before</em></span> the patches stored
  in the Buildroot package directory.
</li><li class="listitem">
<code class="literal">LIBFOO_SITE</code> provides the location of the package, which can be a
  URL or a local filesystem path. HTTP, FTP and SCP are supported URL
  types for retrieving package tarballs. In these cases don’t include a
  trailing slash: it will be added by Buildroot between the directory
  and the filename as appropriate. Git, Subversion, Mercurial,
  and Bazaar are supported URL types for retrieving packages directly
  from source code management systems. There is a helper function to make
  it easier to download source tarballs from GitHub (refer to
  <a class="xref" href="ch18.html#github-download-url" title="18.25.4. How to add a package from GitHub">Section 18.25.4, “How to add a package from GitHub”</a> for details). A filesystem path may be used
  to specify either a tarball or a directory containing the package
  source code. See <code class="literal">LIBFOO_SITE_METHOD</code> below for more details on how
  retrieval works.
  Note that SCP URLs should be of the form
  <code class="literal">scp://[user@]host:filepath</code>, and that filepath is relative to the
  user’s home directory, so you may want to prepend the path with a
  slash for absolute paths:
  <code class="literal">scp://[user@]host:/absolutepath</code>. The same goes for SFTP URLs.
  If <code class="literal">HOST_LIBFOO_SITE</code> is not specified, it defaults to
  <code class="literal">LIBFOO_SITE</code>.
  Examples:
    <code class="literal">LIBFOO_SITE=http://www.libfoosoftware.org/libfoo</code>
    <code class="literal">LIBFOO_SITE=http://svn.xiph.org/trunk/Tremor</code>
    <code class="literal">LIBFOO_SITE=/opt/software/libfoo.tar.gz</code>
    <code class="literal">LIBFOO_SITE=$(TOPDIR)/../src/libfoo</code>
</li><li class="listitem">
<code class="literal">LIBFOO_DL_OPTS</code> is a space-separated list of additional options to
  pass to the downloader. Useful for retrieving documents with
  server-side checking for user logins and passwords, or to use a proxy.
  All download methods valid for <code class="literal">LIBFOO_SITE_METHOD</code> are supported;
  valid options depend on the download method (consult the man page
  for the respective download utilities).
</li><li class="listitem">
<code class="literal">LIBFOO_EXTRA_DOWNLOADS</code> is a space-separated list of additional
  files that Buildroot should download. If an entry contains <code class="literal">://</code>
  then Buildroot will assume it is a complete URL and will download
  the file using this URL. Otherwise, Buildroot will assume the file
  to be downloaded is located at <code class="literal">LIBFOO_SITE</code>. Buildroot will not do
  anything with those additional files, except download them: it will
  be up to the package recipe to use them from <code class="literal">$(LIBFOO_DL_DIR)</code>.
</li><li class="listitem"><p class="simpara">
<code class="literal">LIBFOO_SITE_METHOD</code> determines the method used to fetch or copy the
  package source code. In many cases, Buildroot guesses the method
  from the contents of <code class="literal">LIBFOO_SITE</code> and setting <code class="literal">LIBFOO_SITE_METHOD</code>
  is unnecessary. When <code class="literal">HOST_LIBFOO_SITE_METHOD</code> is not specified, it
  defaults to the value of <code class="literal">LIBFOO_SITE_METHOD</code>.
  The possible values of <code class="literal">LIBFOO_SITE_METHOD</code> are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">wget</code> for normal FTP/HTTP downloads of tarballs. Used by
     default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">http://</code>, <code class="literal">https://</code> or
     <code class="literal">ftp://</code>.
</li><li class="listitem">
<code class="literal">scp</code> for downloads of tarballs over SSH with scp. Used by
     default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">scp://</code>.
</li><li class="listitem">
<code class="literal">sftp</code> for downloads of tarballs over SSH with sftp. Used by
     default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">sftp://</code>.
</li><li class="listitem">
<code class="literal">svn</code> for retrieving source code from a Subversion repository.
     Used by default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">svn://</code>. When a
     <code class="literal">http://</code> Subversion repository URL is specified in
     <code class="literal">LIBFOO_SITE</code>, one <span class="emphasis"><em>must</em></span> specify <code class="literal">LIBFOO_SITE_METHOD=svn</code>.
     Buildroot performs a checkout which is preserved as a tarball in
     the download cache; subsequent builds use the tarball instead of
     performing another checkout.
</li><li class="listitem">
<code class="literal">cvs</code> for retrieving source code from a CVS repository.
     Used by default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">cvs://</code>.
     The downloaded source code is cached as with the <code class="literal">svn</code> method.
     Anonymous pserver mode is assumed otherwise explicitly defined
     on <code class="literal">LIBFOO_SITE</code>. Both
     <code class="literal">LIBFOO_SITE=cvs://libfoo.net:/cvsroot/libfoo</code> and
     <code class="literal">LIBFOO_SITE=cvs://:ext:libfoo.net:/cvsroot/libfoo</code>
     are accepted, on the former anonymous pserver access mode is
     assumed.
     <code class="literal">LIBFOO_SITE</code> <span class="emphasis"><em>must</em></span> contain the source URL as well as the remote
     repository directory. The module is the package name.
     <code class="literal">LIBFOO_VERSION</code> is <span class="emphasis"><em>mandatory</em></span> and <span class="emphasis"><em>must</em></span> be a tag, a branch, or
     a date (e.g. "2014-10-20", "2014-10-20 13:45", "2014-10-20
     13:45+01" see "man cvs" for further details).
</li><li class="listitem">
<code class="literal">git</code> for retrieving source code from a Git repository. Used by
     default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">git://</code>. The downloaded
     source code is cached as with the <code class="literal">svn</code> method.
</li><li class="listitem">
<code class="literal">hg</code> for retrieving source code from a Mercurial repository. One
     <span class="emphasis"><em>must</em></span> specify <code class="literal">LIBFOO_SITE_METHOD=hg</code> when <code class="literal">LIBFOO_SITE</code>
     contains a Mercurial repository URL. The downloaded source code
     is cached as with the <code class="literal">svn</code> method.
</li><li class="listitem">
<code class="literal">bzr</code> for retrieving source code from a Bazaar repository. Used
     by default when <code class="literal">LIBFOO_SITE</code> begins with <code class="literal">bzr://</code>. The
     downloaded source code is cached as with the <code class="literal">svn</code> method.
</li><li class="listitem">
<code class="literal">file</code> for a local tarball. One should use this when
     <code class="literal">LIBFOO_SITE</code> specifies a package tarball as a local filename.
     Useful for software that isn’t available publicly or in version
     control.
</li><li class="listitem">
<code class="literal">local</code> for a local source code directory. One should use this
     when <code class="literal">LIBFOO_SITE</code> specifies a local directory path containing
     the package source code. Buildroot copies the contents of the
     source directory into the package’s build directory. Note that
     for <code class="literal">local</code> packages, no patches are applied. If you need to
     still patch the source code, use <code class="literal">LIBFOO_POST_RSYNC_HOOKS</code>, see
     <a class="xref" href="ch18.html#hooks-rsync" title="18.23.1. Using the POST_RSYNC hook">Section 18.23.1, “Using the <code class="literal">POST_RSYNC</code> hook”</a>.
</li></ul></div></li><li class="listitem">
<code class="literal">LIBFOO_GIT_SUBMODULES</code> can be set to <code class="literal">YES</code> to create an archive
  with the git submodules in the repository.  This is only available
  for packages downloaded with git (i.e. when
  <code class="literal">LIBFOO_SITE_METHOD=git</code>).  Note that we try not to use such git
  submodules when they contain bundled libraries, in which case we
  prefer to use those libraries from their own package.
</li><li class="listitem">
<code class="literal">LIBFOO_GIT_LFS</code> should be set to <code class="literal">YES</code> if the Git repository uses
  Git LFS to store large files out of band.  This is only available for
  packages downloaded with git (i.e. when <code class="literal">LIBFOO_SITE_METHOD=git</code>).
</li><li class="listitem">
<code class="literal">LIBFOO_STRIP_COMPONENTS</code> is the number of leading components
  (directories) that tar must strip from file names on extraction.
  The tarball for most packages has one leading component named
  "&lt;pkg-name&gt;-&lt;pkg-version&gt;", thus Buildroot passes
  --strip-components=1 to tar to remove it.
  For non-standard packages that don’t have this component, or
  that have more than one leading component to strip, set this
  variable with the value to be passed to tar. Default: 1.
</li><li class="listitem">
<code class="literal">LIBFOO_EXCLUDES</code> is a space-separated list of patterns to exclude
  when extracting the archive. Each item from that list is passed as
  a tar’s <code class="literal">--exclude</code> option. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_DEPENDENCIES</code> lists the dependencies (in terms of package
  name) that are required for the current target package to
  compile. These dependencies are guaranteed to be compiled and
  installed before the configuration of the current package starts.
  However, modifications to configuration of these dependencies will
  not force a rebuild of the current package. In a similar way,
  <code class="literal">HOST_LIBFOO_DEPENDENCIES</code> lists the dependencies for the current
  host package.
</li><li class="listitem">
<code class="literal">LIBFOO_EXTRACT_DEPENDENCIES</code> lists the dependencies (in terms of
  package name) that are required for the current target package to be
  extracted. These dependencies are guaranteed to be compiled and
  installed before the extract step of the current package
  starts. This is only used internally by the package infrastructure,
  and should typically not be used directly by packages.
</li><li class="listitem">
<code class="literal">LIBFOO_PATCH_DEPENDENCIES</code> lists the dependencies (in terms of
  package name) that are required for the current package to be
  patched. These dependencies are guaranteed to be extracted and
  patched (but not necessarily built) before the current package is
  patched. In a similar way, <code class="literal">HOST_LIBFOO_PATCH_DEPENDENCIES</code> lists
  the dependencies for the current host package.
  This is seldom used; usually, <code class="literal">LIBFOO_DEPENDENCIES</code> is what you
  really want to use.
</li><li class="listitem">
<code class="literal">LIBFOO_PROVIDES</code> lists all the virtual packages <code class="literal">libfoo</code> is an
  implementation of. See <a class="xref" href="ch18.html#virtual-package-tutorial">Section 18.12, “Infrastructure for virtual packages”</a>.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_STAGING</code> can be set to <code class="literal">YES</code> or <code class="literal">NO</code> (default). If
  set to <code class="literal">YES</code>, then the commands in the <code class="literal">LIBFOO_INSTALL_STAGING_CMDS</code>
  variables are executed to install the package into the staging
  directory.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_TARGET</code> can be set to <code class="literal">YES</code> (default) or <code class="literal">NO</code>. If
  set to <code class="literal">YES</code>, then the commands in the <code class="literal">LIBFOO_INSTALL_TARGET_CMDS</code>
  variables are executed to install the package into the target
  directory.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_IMAGES</code> can be set to <code class="literal">YES</code> or <code class="literal">NO</code> (default). If
  set to <code class="literal">YES</code>, then the commands in the <code class="literal">LIBFOO_INSTALL_IMAGES_CMDS</code>
  variable are executed to install the package into the images
  directory.
</li><li class="listitem">
<code class="literal">LIBFOO_CONFIG_SCRIPTS</code> lists the names of the files in
  <span class="emphasis"><em>$(STAGING_DIR)/usr/bin</em></span> that need some special fixing to make them
  cross-compiling friendly. Multiple file names separated by space can
  be given and all are relative to <span class="emphasis"><em>$(STAGING_DIR)/usr/bin</em></span>. The files
  listed in <code class="literal">LIBFOO_CONFIG_SCRIPTS</code> are also removed from
  <code class="literal">$(TARGET_DIR)/usr/bin</code> since they are not needed on the target.
</li><li class="listitem">
<code class="literal">LIBFOO_DEVICES</code> lists the device files to be created by Buildroot
  when using the static device table. The syntax to use is the
  makedevs one. You can find some documentation for this syntax in the
  <a class="xref" href="ch25.html" title="Chapter 25. Makedev syntax documentation">Chapter 25, <em>Makedev syntax documentation</em></a>. This variable is optional.
</li><li class="listitem">
<code class="literal">LIBFOO_PERMISSIONS</code> lists the changes of permissions to be done at
  the end of the build process. The syntax is once again the makedevs one.
  You can find some documentation for this syntax in the <a class="xref" href="ch25.html" title="Chapter 25. Makedev syntax documentation">Chapter 25, <em>Makedev syntax documentation</em></a>.
  This variable is optional.
</li><li class="listitem">
<code class="literal">LIBFOO_USERS</code> lists the users to create for this package, if it installs
  a program you want to run as a specific user (e.g. as a daemon, or as a
  cron-job). The syntax is similar in spirit to the makedevs one, and is
  described in the <a class="xref" href="ch26.html" title="Chapter 26. Makeusers syntax documentation">Chapter 26, <em>Makeusers syntax documentation</em></a>. This variable is optional.
</li><li class="listitem"><p class="simpara">
<code class="literal">LIBFOO_LICENSE</code> defines the license (or licenses) under which the package
  is released.
  This name will appear in the manifest file produced by <code class="literal">make legal-info</code>.
  If the license appears in <a class="ulink" href="https://spdx.org/licenses/" target="_top">the SPDX License List</a>,
  use the SPDX short identifier to make the manifest file uniform.
  Otherwise, describe the license in a precise and concise way, avoiding
  ambiguous names such as <code class="literal">BSD</code> which actually name a family of licenses.
  This variable is optional. If it is not defined, <code class="literal">unknown</code> will appear in
  the <code class="literal">license</code> field of the manifest file for this package.
  The expected format for this variable must comply with the following rules:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
If different parts of the package are released under different
     licenses, then <code class="literal">comma</code> separate licenses (e.g. <code class="literal"><code class="literal">LIBFOO_LICENSE =
     GPL-2.0+, LGPL-2.1+</code></code>). If there is clear distinction between which
     component is licensed under what license, then annotate the license
     with that component, between parenthesis (e.g. <code class="literal"><code class="literal">LIBFOO_LICENSE =
     GPL-2.0+ (programs), LGPL-2.1+ (libraries)</code></code>).
</li><li class="listitem">
If some licenses are conditioned on a sub-option being enabled, append
     the conditional licenses with a comma (e.g.: <code class="literal">FOO_LICENSE += , GPL-2.0+
     (programs)</code>); the infrastructure will internally remove the space before
     the comma.
</li><li class="listitem">
If the package is dual licensed, then separate licenses with the
     <code class="literal">or</code> keyword (e.g. <code class="literal"><code class="literal">LIBFOO_LICENSE = AFL-2.1 or GPL-2.0+</code></code>).
</li></ul></div></li><li class="listitem">
<code class="literal">LIBFOO_LICENSE_FILES</code> is a space-separated list of files in the package
  tarball that contain the license(s) under which the package is released.
  <code class="literal">make legal-info</code> copies all of these files in the <code class="literal">legal-info</code> directory.
  See <a class="xref" href="ch13.html" title="Chapter 13. Legal notice and licensing">Chapter 13, <em>Legal notice and licensing</em></a> for more information.
  This variable is optional. If it is not defined, a warning will be produced
  to let you know, and <code class="literal">not saved</code> will appear in the <code class="literal">license files</code> field
  of the manifest file for this package.
</li><li class="listitem">
<code class="literal">LIBFOO_ACTUAL_SOURCE_TARBALL</code> only applies to packages whose
  <code class="literal">LIBFOO_SITE</code> / <code class="literal">LIBFOO_SOURCE</code> pair points to an archive that does
  not actually contain source code, but binary code. This a very
  uncommon case, only known to apply to external toolchains which come
  already compiled, although theoretically it might apply to other
  packages. In such cases a separate tarball is usually available with
  the actual source code. Set <code class="literal">LIBFOO_ACTUAL_SOURCE_TARBALL</code> to the
  name of the actual source code archive and Buildroot will download
  it and use it when you run <code class="literal">make legal-info</code> to collect
  legally-relevant material.  Note this file will not be downloaded
  during regular builds nor by <code class="literal">make source</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_ACTUAL_SOURCE_SITE</code> provides the location of the actual
  source tarball. The default value is <code class="literal">LIBFOO_SITE</code>, so you don’t
  need to set this variable if the binary and source archives are
  hosted on the same directory.  If <code class="literal">LIBFOO_ACTUAL_SOURCE_TARBALL</code> is
  not set, it doesn’t make sense to define
  <code class="literal">LIBFOO_ACTUAL_SOURCE_SITE</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_REDISTRIBUTE</code> can be set to <code class="literal">YES</code> (default) or <code class="literal">NO</code> to indicate if
  the package source code is allowed to be redistributed. Set it to <code class="literal">NO</code> for
  non-opensource packages: Buildroot will not save the source code for this
  package when collecting the <code class="literal">legal-info</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_FLAT_STACKSIZE</code> defines the stack size of an application built into
  the FLAT binary format. The application stack size on the NOMMU architecture
  processors can’t be enlarged at run time. The default stack size for the
  FLAT binary format is only 4k bytes. If the application consumes more stack,
  append the required number here.
</li><li class="listitem">
<code class="literal">LIBFOO_BIN_ARCH_EXCLUDE</code> is a space-separated list of paths (relative
  to the target directory) to ignore when checking that the package
  installs correctly cross-compiled binaries. You seldom need to set this
  variable, unless the package installs binary blobs outside the default
  locations, <code class="literal">/lib/firmware</code>, <code class="literal">/usr/lib/firmware</code>, <code class="literal">/lib/modules</code>,
  <code class="literal">/usr/lib/modules</code>, and <code class="literal">/usr/share</code>, which are automatically excluded.
</li><li class="listitem">
<code class="literal">LIBFOO_IGNORE_CVES</code> is a space-separated list of CVEs that tells
  Buildroot CVE tracking tools which CVEs should be ignored for this
  package. This is typically used when the CVE is fixed by a patch in
  the package, or when the CVE for some reason does not affect the
  Buildroot package. A Makefile comment must always precede the
  addition of a CVE to this variable. Example:
</li></ul></div><pre class="screen"># 0001-fix-cve-2020-12345.patch
LIBFOO_IGNORE_CVES += CVE-2020-12345
# only when built with libbaz, which Buildroot doesn't support
LIBFOO_IGNORE_CVES += CVE-2020-54321</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
<code class="literal">LIBFOO_CPE_ID_*</code> variables is a set of variables that allows the
  package to define its <a class="ulink" href="https://nvd.nist.gov/products/cpe" target="_top">CPE
  identifier</a>. The available variables are:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">LIBFOO_CPE_ID_PREFIX</code>, specifies the prefix of the CPE identifier,
   i.e the first three fields. When not defined, the default value is
   <code class="literal">cpe:2.3:a</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_CPE_ID_VENDOR</code>, specifies the vendor part of the CPE
   identifier. When not defined, the default value is
   <code class="literal">&lt;pkgname&gt;_project</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_CPE_ID_PRODUCT</code>, specifies the product part of the CPE
   identifier. When not defined, the default value is <code class="literal">&lt;pkgname&gt;</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_CPE_ID_VERSION</code>, specifies the version part of the CPE
   identifier. When not defined the default value is
   <code class="literal">$(LIBFOO_VERSION)</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_CPE_ID_UPDATE</code> specifies the <span class="emphasis"><em>update</em></span> part of the CPE
   identifier. When not defined the default value is <code class="literal">*</code>.
</li></ul></div><p class="simpara">If any of those variables is defined, then the generic package
infrastructure assumes the package provides valid CPE information. In
this case, the generic package infrastructure will define
<code class="literal">LIBFOO_CPE_ID</code>.</p><p class="simpara">For a host package, if its <code class="literal">LIBFOO_CPE_ID_*</code> variables are not
defined, it inherits the value of those variables from the
corresponding target package.</p></li></ul></div><p>The recommended way to define these variables is to use the following
syntax:</p><pre class="screen">LIBFOO_VERSION = 2.32</pre><p>Now, the variables that define what should be performed at the
different steps of the build process.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LIBFOO_EXTRACT_CMDS</code> lists the actions to be performed to extract
  the package. This is generally not needed as tarballs are
  automatically handled by Buildroot. However, if the package uses a
  non-standard archive format, such as a ZIP or RAR file, or has a
  tarball with a non-standard organization, this variable allows to
  override the package infrastructure default behavior.
</li><li class="listitem">
<code class="literal">LIBFOO_CONFIGURE_CMDS</code> lists the actions to be performed to
  configure the package before its compilation.
</li><li class="listitem">
<code class="literal">LIBFOO_BUILD_CMDS</code> lists the actions to be performed to
  compile the package.
</li><li class="listitem">
<code class="literal">HOST_LIBFOO_INSTALL_CMDS</code> lists the actions to be performed
  to install the package, when the package is a host package. The
  package must install its files to the directory given by
  <code class="literal">$(HOST_DIR)</code>. All files, including development files such as
  headers should be installed, since other packages might be compiled
  on top of this package.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_TARGET_CMDS</code> lists the actions to be
  performed to install the package to the target directory, when the
  package is a target package. The package must install its files to
  the directory given by <code class="literal">$(TARGET_DIR)</code>. Only the files required for
  <span class="emphasis"><em>execution</em></span> of the package have to be
  installed. Header files, static libraries and documentation will be
  removed again when the target filesystem is finalized.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_STAGING_CMDS</code> lists the actions to be
  performed to install the package to the staging directory, when the
  package is a target package. The package must install its files to
  the directory given by <code class="literal">$(STAGING_DIR)</code>. All development files
  should be installed, since they might be needed to compile other
  packages.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_IMAGES_CMDS</code> lists the actions to be performed to
  install the package to the images directory, when the package is a
  target package. The package must install its files to the directory
  given by <code class="literal">$(BINARIES_DIR)</code>. Only files that are binary images (aka
  images) that do not belong in the <code class="literal">TARGET_DIR</code> but are necessary
  for booting the board should be placed here. For example, a package
  should utilize this step if it has binaries which would be similar
  to the kernel image, bootloader or root filesystem images.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_INIT_SYSV</code>, <code class="literal">LIBFOO_INSTALL_INIT_OPENRC</code> and
  <code class="literal">LIBFOO_INSTALL_INIT_SYSTEMD</code> list the actions to install init
  scripts either for the systemV-like init systems (busybox,
  sysvinit, etc.), openrc or for the systemd units. These commands
  will be run only when the relevant init system is installed (i.e.
  if systemd is selected as the init system in the configuration,
  only <code class="literal">LIBFOO_INSTALL_INIT_SYSTEMD</code> will be run). The only exception
  is when openrc is chosen as init system and <code class="literal">LIBFOO_INSTALL_INIT_OPENRC</code>
  has not been set, in such situation <code class="literal">LIBFOO_INSTALL_INIT_SYSV</code> will
  be called, since openrc supports sysv init scripts.
  When systemd is used as the init system, buildroot will automatically enable
  all services using the <code class="literal">systemctl preset-all</code> command in the final phase of
  image building. You can add preset files to prevent a particular unit from
  being automatically enabled by buildroot.
</li><li class="listitem">
<code class="literal">LIBFOO_HELP_CMDS</code> lists the actions to print the package help, which
  is included to the main <code class="literal">make help</code> output. These commands can print
  anything in any format.
  This is seldom used, as packages rarely have custom rules. <span class="strong"><strong>Do not use
  this variable</strong></span>, unless you really know that you need to print help.
</li><li class="listitem">
<code class="literal">LIBFOO_LINUX_CONFIG_FIXUPS</code> lists the Linux kernel configuration
  options that are needed to build and use this package, and without
  which the package is fundamentally broken. This shall be a set of
  calls to one of the kconfig tweaking option: <code class="literal">KCONFIG_ENABLE_OPT</code>,
  <code class="literal">KCONFIG_DISABLE_OPT</code>, or <code class="literal">KCONFIG_SET_OPT</code>.
  This is seldom used, as package usually have no strict requirements on
  the kernel options.
</li></ul></div><p>The preferred way to define these variables is:</p><pre class="screen">define LIBFOO_CONFIGURE_CMDS
        action 1
        action 2
        action 3
endef</pre><p>In the action definitions, you can use the following variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">$(LIBFOO_PKGDIR)</code> contains the path to the directory containing the
  <code class="literal">libfoo.mk</code> and <code class="literal">Config.in</code> files. This variable is useful when it is
  necessary to install a file bundled in Buildroot, like a runtime
  configuration file, a splashscreen image…
</li><li class="listitem">
<code class="literal">$(@D)</code>, which contains the directory in which the package source
  code has been uncompressed.
</li><li class="listitem">
<code class="literal">$(LIBFOO_DL_DIR)</code> contains the path to the directory where all the downloads
  made by Buildroot for <code class="literal">libfoo</code> are stored in.
</li><li class="listitem">
<code class="literal">$(TARGET_CC)</code>, <code class="literal">$(TARGET_LD)</code>, etc. to get the target
  cross-compilation utilities
</li><li class="listitem">
<code class="literal">$(TARGET_CROSS)</code> to get the cross-compilation toolchain prefix
</li><li class="listitem">
Of course the <code class="literal">$(HOST_DIR)</code>, <code class="literal">$(STAGING_DIR)</code> and <code class="literal">$(TARGET_DIR)</code>
  variables to install the packages properly. Those variables point to
  the global <span class="emphasis"><em>host</em></span>, <span class="emphasis"><em>staging</em></span> and <span class="emphasis"><em>target</em></span> directories, unless
  <span class="emphasis"><em>per-package directory</em></span> support is used, in which case they point to
  the current package <span class="emphasis"><em>host</em></span>, <span class="emphasis"><em>staging</em></span> and <span class="emphasis"><em>target</em></span> directories. In
  both cases, it doesn’t make any difference from the package point of
  view: it should simply use <code class="literal">HOST_DIR</code>, <code class="literal">STAGING_DIR</code> and
  <code class="literal">TARGET_DIR</code>. See <a class="xref" href="ch08.html#top-level-parallel-build" title="8.12. Top-level parallel build">Section 8.12, “Top-level parallel build”</a> for more details
  about <span class="emphasis"><em>per-package directory</em></span> support.
</li></ul></div><p>Finally, you can also use hooks. See <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for more information.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_autotools_based_packages"></a>18.7. Infrastructure for autotools-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="autotools-package-tutorial"></a>18.7.1. <code class="literal">autotools-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for an autotools-based
package, with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # libfoo
04: #
05: ################################################################################
06:
07: LIBFOO_VERSION = 1.0
08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz
09: LIBFOO_SITE = http://www.foosoftware.org/download
10: LIBFOO_INSTALL_STAGING = YES
11: LIBFOO_INSTALL_TARGET = NO
12: LIBFOO_CONF_OPTS = --disable-shared
13: LIBFOO_DEPENDENCIES = libglib2 host-pkgconf
14:
15: $(eval $(autotools-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended)
and the location of the tarball on the Web. Buildroot will automatically
download the tarball from this location.</p><p>On line 10, we tell Buildroot to install the package to the staging
directory. The staging directory, located in <code class="literal">output/staging/</code>
is the directory where all the packages are installed, including their
development files, etc. By default, packages are not installed to the
staging directory, since usually, only libraries need to be installed in
the staging directory: their development files are needed to compile
other libraries or applications depending on them. Also by default, when
staging installation is enabled, packages are installed in this location
using the <code class="literal">make install</code> command.</p><p>On line 11, we tell Buildroot to not install the package to the
target directory. This directory contains what will become the root
filesystem running on the target. For purely static libraries, it is
not necessary to install them in the target directory because they will
not be used at runtime. By default, target installation is enabled; setting
this variable to NO is almost never needed. Also by default, packages are
installed in this location using the <code class="literal">make install</code> command.</p><p>On line 12, we tell Buildroot to pass a custom configure option, that
will be passed to the <code class="literal">./configure</code> script before configuring
and building the package.</p><p>On line 13, we declare our dependencies, so that they are built
before the build process of our package starts.</p><p>Finally, on line line 15, we invoke the <code class="literal">autotools-package</code>
macro that generates all the Makefile rules that actually allows the
package to be built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="autotools-package-reference"></a>18.7.2. <code class="literal">autotools-package</code> reference</h3></div></div></div><p>The main macro of the autotools package infrastructure is
<code class="literal">autotools-package</code>. It is similar to the <code class="literal">generic-package</code> macro. The ability to
have target and host packages is also available, with the
<code class="literal">host-autotools-package</code> macro.</p><p>Just like the generic infrastructure, the autotools infrastructure
works by defining a number of variables before calling the
<code class="literal">autotools-package</code> macro.</p><p>First, all the package metadata information variables that exist in the
generic infrastructure also exist in the autotools infrastructure:
<code class="literal">LIBFOO_VERSION</code>, <code class="literal">LIBFOO_SOURCE</code>,
<code class="literal">LIBFOO_PATCH</code>, <code class="literal">LIBFOO_SITE</code>,
<code class="literal">LIBFOO_SUBDIR</code>, <code class="literal">LIBFOO_DEPENDENCIES</code>,
<code class="literal">LIBFOO_INSTALL_STAGING</code>, <code class="literal">LIBFOO_INSTALL_TARGET</code>.</p><p>A few additional variables, specific to the autotools infrastructure,
can also be defined. Many of them are only useful in very specific
cases, typical packages will therefore only use a few of them.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LIBFOO_SUBDIR</code> may contain the name of a subdirectory
  inside the package that contains the configure script. This is useful,
  if for example, the main configure script is not at the root of the
  tree extracted by the tarball. If <code class="literal">HOST_LIBFOO_SUBDIR</code> is
  not specified, it defaults to <code class="literal">LIBFOO_SUBDIR</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_CONF_ENV</code>, to specify additional environment
  variables to pass to the configure script. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_CONF_OPTS</code>, to specify additional configure
  options to pass to the configure script. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE</code>, to specify an alternate <code class="literal">make</code>
  command. This is typically useful when parallel make is enabled in
  the configuration (using <code class="literal">BR2_JLEVEL</code>) but that this
  feature should be disabled for the given package, for one reason or
  another. By default, set to <code class="literal">$(MAKE)</code>. If parallel building
  is not supported by the package, then it should be set to
  <code class="literal">LIBFOO_MAKE=$(MAKE1)</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE_ENV</code>, to specify additional environment
  variables to pass to make in the build step. These are passed before
  the <code class="literal">make</code> command. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE_OPTS</code>, to specify additional variables to
  pass to make in the build step. These are passed after the
  <code class="literal">make</code> command. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_AUTORECONF</code>, tells whether the package should
  be autoreconfigured or not (i.e. if the configure script and
  Makefile.in files should be re-generated by re-running autoconf,
  automake, libtool, etc.). Valid values are <code class="literal">YES</code> and
  <code class="literal">NO</code>. By default, the value is <code class="literal">NO</code>
</li><li class="listitem">
<code class="literal">LIBFOO_AUTORECONF_ENV</code>, to specify additional environment
  variables to pass to the <span class="emphasis"><em>autoreconf</em></span> program if
  <code class="literal">LIBFOO_AUTORECONF=YES</code>. These are passed in the environment of
  the <span class="emphasis"><em>autoreconf</em></span> command. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_AUTORECONF_OPTS</code> to specify additional options
  passed to the <span class="emphasis"><em>autoreconf</em></span> program if
  <code class="literal">LIBFOO_AUTORECONF=YES</code>. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_GETTEXTIZE</code>, tells whether the package should be
  gettextized or not (i.e. if the package uses a different gettext
  version than Buildroot provides, and it is needed to run
  <span class="emphasis"><em>gettextize</em></span>.) Only valid when <code class="literal">LIBFOO_AUTORECONF=YES</code>. Valid
  values are <code class="literal">YES</code> and <code class="literal">NO</code>. The default is <code class="literal">NO</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_GETTEXTIZE_OPTS</code>, to specify additional options passed to
  the <span class="emphasis"><em>gettextize</em></span> program, if <code class="literal">LIBFOO_GETTEXTIZE=YES</code>. You may
  use that if, for example, the <code class="literal">.po</code> files are not located in the
  standard place (i.e. in <code class="literal">po/</code> at the root of the package.) By
  default, <span class="emphasis"><em>-f</em></span>.
</li><li class="listitem">
<code class="literal">LIBFOO_LIBTOOL_PATCH</code> tells whether the Buildroot
  patch to fix libtool cross-compilation issues should be applied or
  not. Valid values are <code class="literal">YES</code> and <code class="literal">NO</code>. By
  default, the value is <code class="literal">YES</code>
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_STAGING_OPTS</code> contains the make options
  used to install the package to the staging directory. By default, the
  value is <code class="literal">DESTDIR=$(STAGING_DIR) install</code>, which is
  correct for most autotools packages. It is still possible to override
  it.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_TARGET_OPTS</code> contains the make options
  used to install the package to the target directory. By default, the
  value is <code class="literal">DESTDIR=$(TARGET_DIR) install</code>. The default
  value is correct for most autotools packages, but it is still possible
  to override it if needed.
</li></ul></div><p>With the autotools infrastructure, all the steps required to build
and install the packages are already defined, and they generally work
well for most autotools-based packages. However, when required, it is
still possible to customize what is done in any particular step:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
By adding a post-operation hook (after extract, patch, configure,
  build or install). See <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for details.
</li><li class="listitem">
By overriding one of the steps. For example, even if the autotools
  infrastructure is used, if the package <code class="literal">.mk</code> file defines its
  own <code class="literal">LIBFOO_CONFIGURE_CMDS</code> variable, it will be used
  instead of the default autotools one. However, using this method
  should be restricted to very specific cases. Do not use it in the
  general case.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_cmake_based_packages"></a>18.8. Infrastructure for CMake-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cmake-package-tutorial"></a>18.8.1. <code class="literal">cmake-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a CMake-based package,
with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # libfoo
04: #
05: ################################################################################
06:
07: LIBFOO_VERSION = 1.0
08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz
09: LIBFOO_SITE = http://www.foosoftware.org/download
10: LIBFOO_INSTALL_STAGING = YES
11: LIBFOO_INSTALL_TARGET = NO
12: LIBFOO_CONF_OPTS = -DBUILD_DEMOS=ON
13: LIBFOO_DEPENDENCIES = libglib2 host-pkgconf
14:
15: $(eval $(cmake-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball recommended)
and the location of the tarball on the Web. Buildroot will automatically
download the tarball from this location.</p><p>On line 10, we tell Buildroot to install the package to the staging
directory. The staging directory, located in <code class="literal">output/staging/</code>
is the directory where all the packages are installed, including their
development files, etc. By default, packages are not installed to the
staging directory, since usually, only libraries need to be installed in
the staging directory: their development files are needed to compile
other libraries or applications depending on them. Also by default, when
staging installation is enabled, packages are installed in this location
using the <code class="literal">make install</code> command.</p><p>On line 11, we tell Buildroot to not install the package to the
target directory. This directory contains what will become the root
filesystem running on the target. For purely static libraries, it is
not necessary to install them in the target directory because they will
not be used at runtime. By default, target installation is enabled; setting
this variable to NO is almost never needed. Also by default, packages are
installed in this location using the <code class="literal">make install</code> command.</p><p>On line 12, we tell Buildroot to pass custom options to CMake when it is
configuring the package.</p><p>On line 13, we declare our dependencies, so that they are built
before the build process of our package starts.</p><p>Finally, on line line 15, we invoke the <code class="literal">cmake-package</code>
macro that generates all the Makefile rules that actually allows the
package to be built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cmake-package-reference"></a>18.8.2. <code class="literal">cmake-package</code> reference</h3></div></div></div><p>The main macro of the CMake package infrastructure is
<code class="literal">cmake-package</code>. It is similar to the <code class="literal">generic-package</code> macro. The ability to
have target and host packages is also available, with the
<code class="literal">host-cmake-package</code> macro.</p><p>Just like the generic infrastructure, the CMake infrastructure works
by defining a number of variables before calling the <code class="literal">cmake-package</code>
macro.</p><p>First, all the package metadata information variables that exist in
the generic infrastructure also exist in the CMake infrastructure:
<code class="literal">LIBFOO_VERSION</code>, <code class="literal">LIBFOO_SOURCE</code>, <code class="literal">LIBFOO_PATCH</code>, <code class="literal">LIBFOO_SITE</code>,
<code class="literal">LIBFOO_SUBDIR</code>, <code class="literal">LIBFOO_DEPENDENCIES</code>, <code class="literal">LIBFOO_INSTALL_STAGING</code>,
<code class="literal">LIBFOO_INSTALL_TARGET</code>.</p><p>A few additional variables, specific to the CMake infrastructure, can
also be defined. Many of them are only useful in very specific cases,
typical packages will therefore only use a few of them.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LIBFOO_SUBDIR</code> may contain the name of a subdirectory inside the
  package that contains the main CMakeLists.txt file. This is useful,
  if for example, the main CMakeLists.txt file is not at the root of
  the tree extracted by the tarball. If <code class="literal">HOST_LIBFOO_SUBDIR</code> is not
  specified, it defaults to <code class="literal">LIBFOO_SUBDIR</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_CONF_ENV</code>, to specify additional environment variables to
  pass to CMake. By default, empty.
</li><li class="listitem"><p class="simpara">
<code class="literal">LIBFOO_CONF_OPTS</code>, to specify additional configure options to pass
  to CMake. By default, empty. A number of common CMake options are
  set by the <code class="literal">cmake-package</code> infrastructure; so it is normally not
  necessary to set them in the package’s <code class="literal">*.mk</code> file unless you want
  to override them:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">CMAKE_BUILD_TYPE</code> is driven by <code class="literal">BR2_ENABLE_RUNTIME_DEBUG</code>;
</li><li class="listitem">
<code class="literal">CMAKE_INSTALL_PREFIX</code>;
</li><li class="listitem">
<code class="literal">BUILD_SHARED_LIBS</code> is driven by <code class="literal">BR2_STATIC_LIBS</code>;
</li><li class="listitem">
<code class="literal">BUILD_DOC</code>, <code class="literal">BUILD_DOCS</code> are disabled;
</li><li class="listitem">
<code class="literal">BUILD_EXAMPLE</code>, <code class="literal">BUILD_EXAMPLES</code> are disabled;
</li><li class="listitem">
<code class="literal">BUILD_TEST</code>, <code class="literal">BUILD_TESTS</code>, <code class="literal">BUILD_TESTING</code> are disabled.
</li></ul></div></li><li class="listitem">
<code class="literal">LIBFOO_SUPPORTS_IN_SOURCE_BUILD = NO</code> should be set when the package
  cannot be built inside the source tree but needs a separate build
  directory.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE</code>, to specify an alternate <code class="literal">make</code> command. This is
  typically useful when parallel make is enabled in the configuration
  (using <code class="literal">BR2_JLEVEL</code>) but that this feature should be disabled for
  the given package, for one reason or another. By default, set to
  <code class="literal">$(MAKE)</code>. If parallel building is not supported by the package,
  then it should be set to <code class="literal">LIBFOO_MAKE=$(MAKE1)</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE_ENV</code>, to specify additional environment variables to
  pass to make in the build step. These are passed before the <code class="literal">make</code>
  command. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE_OPTS</code>, to specify additional variables to pass to make
  in the build step. These are passed after the <code class="literal">make</code> command. By
  default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_OPTS</code> contains the make options used to
  install the package to the host directory. By default, the value
  is <code class="literal">install</code>, which is correct for most CMake packages. It is still
  possible to override it.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_STAGING_OPTS</code> contains the make options used to
  install the package to the staging directory. By default, the value
  is <code class="literal">DESTDIR=$(STAGING_DIR) install/fast</code>, which is correct for most
  CMake packages. It is still possible to override it.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_TARGET_OPTS</code> contains the make options used to
  install the package to the target directory. By default, the value
  is <code class="literal">DESTDIR=$(TARGET_DIR) install/fast</code>. The default value is correct
  for most CMake packages, but it is still possible to override it if
  needed.
</li></ul></div><p>With the CMake infrastructure, all the steps required to build and
install the packages are already defined, and they generally work well
for most CMake-based packages. However, when required, it is still
possible to customize what is done in any particular step:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
By adding a post-operation hook (after extract, patch, configure,
  build or install). See <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for details.
</li><li class="listitem">
By overriding one of the steps. For example, even if the CMake
  infrastructure is used, if the package <code class="literal">.mk</code> file defines its own
  <code class="literal">LIBFOO_CONFIGURE_CMDS</code> variable, it will be used instead of the
  default CMake one. However, using this method should be restricted
  to very specific cases. Do not use it in the general case.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_python_packages"></a>18.9. Infrastructure for Python packages</h2></div></div></div><p>This infrastructure applies to Python packages that use the standard
Python setuptools mechanism as their build system, generally
recognizable by the usage of a <code class="literal">setup.py</code> script.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="python-package-tutorial"></a>18.9.1. <code class="literal">python-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a Python package,
with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # python-foo
04: #
05: ################################################################################
06:
07: PYTHON_FOO_VERSION = 1.0
08: PYTHON_FOO_SOURCE = python-foo-$(PYTHON_FOO_VERSION).tar.xz
09: PYTHON_FOO_SITE = http://www.foosoftware.org/download
10: PYTHON_FOO_LICENSE = BSD-3-Clause
11: PYTHON_FOO_LICENSE_FILES = LICENSE
12: PYTHON_FOO_ENV = SOME_VAR=1
13: PYTHON_FOO_DEPENDENCIES = libmad
14: PYTHON_FOO_SETUP_TYPE = distutils
15:
16: $(eval $(python-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball
recommended) and the location of the tarball on the Web. Buildroot
will automatically download the tarball from this location.</p><p>On line 10 and 11, we give licensing details about the package (its
license on line 10, and the file containing the license text on line
11).</p><p>On line 12, we tell Buildroot to pass custom options to the Python
<code class="literal">setup.py</code> script when it is configuring the package.</p><p>On line 13, we declare our dependencies, so that they are built
before the build process of our package starts.</p><p>On line 14, we declare the specific Python build system being used. In
this case the <code class="literal">distutils</code> Python build system is used. The two
supported ones are <code class="literal">distutils</code> and <code class="literal">setuptools</code>.</p><p>Finally, on line 16, we invoke the <code class="literal">python-package</code> macro that
generates all the Makefile rules that actually allow the package to be
built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="python-package-reference"></a>18.9.2. <code class="literal">python-package</code> reference</h3></div></div></div><p>As a policy, packages that merely provide Python modules should all be
named <code class="literal">python-&lt;something&gt;</code> in Buildroot. Other packages that use the
Python build system, but are not Python modules, can freely choose
their name (existing examples in Buildroot are <code class="literal">scons</code> and
<code class="literal">supervisor</code>).</p><p>The main macro of the Python package infrastructure is
<code class="literal">python-package</code>. It is similar to the <code class="literal">generic-package</code> macro. It is
also possible to create Python host packages with the
<code class="literal">host-python-package</code> macro.</p><p>Just like the generic infrastructure, the Python infrastructure works
by defining a number of variables before calling the <code class="literal">python-package</code>
or <code class="literal">host-python-package</code> macros.</p><p>All the package metadata information variables that exist in the
<a class="link" href="ch18.html#generic-package-reference" title="18.6.2. generic-package reference">generic package infrastructure</a> also
exist in the Python infrastructure: <code class="literal">PYTHON_FOO_VERSION</code>,
<code class="literal">PYTHON_FOO_SOURCE</code>, <code class="literal">PYTHON_FOO_PATCH</code>, <code class="literal">PYTHON_FOO_SITE</code>,
<code class="literal">PYTHON_FOO_SUBDIR</code>, <code class="literal">PYTHON_FOO_DEPENDENCIES</code>, <code class="literal">PYTHON_FOO_LICENSE</code>,
<code class="literal">PYTHON_FOO_LICENSE_FILES</code>, <code class="literal">PYTHON_FOO_INSTALL_STAGING</code>, etc.</p><p>Note that:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
It is not necessary to add <code class="literal">python</code> or <code class="literal">host-python</code> in the
   <code class="literal">PYTHON_FOO_DEPENDENCIES</code> variable of a package, since these basic
   dependencies are automatically added as needed by the Python
   package infrastructure.
</li><li class="listitem">
Similarly, it is not needed to add <code class="literal">host-setuptools</code> to
   <code class="literal">PYTHON_FOO_DEPENDENCIES</code> for setuptools-based packages, since it’s
   automatically added by the Python infrastructure as needed.
</li></ul></div><p>One variable specific to the Python infrastructure is mandatory:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">PYTHON_FOO_SETUP_TYPE</code>, to define which Python build system is used
  by the package. The two supported values are <code class="literal">distutils</code> and
  <code class="literal">setuptools</code>. If you don’t know which one is used in your package,
  look at the <code class="literal">setup.py</code> file in your package source code, and see
  whether it imports things from the <code class="literal">distutils</code> module or the
  <code class="literal">setuptools</code> module.
</li></ul></div><p>A few additional variables, specific to the Python infrastructure, can
optionally be defined, depending on the package’s needs. Many of them
are only useful in very specific cases, typical packages will
therefore only use a few of them, or none.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">PYTHON_FOO_SUBDIR</code> may contain the name of a subdirectory inside the
  package that contains the main <code class="literal">setup.py</code> file. This is useful,
  if for example, the main <code class="literal">setup.py</code> file is not at the root of
  the tree extracted by the tarball. If <code class="literal">HOST_PYTHON_FOO_SUBDIR</code> is not
  specified, it defaults to <code class="literal">PYTHON_FOO_SUBDIR</code>.
</li><li class="listitem">
<code class="literal">PYTHON_FOO_ENV</code>, to specify additional environment variables to
  pass to the Python <code class="literal">setup.py</code> script (for both the build and install
  steps). Note that the infrastructure is automatically passing
  several standard variables, defined in <code class="literal">PKG_PYTHON_DISTUTILS_ENV</code>
  (for distutils target packages), <code class="literal">HOST_PKG_PYTHON_DISTUTILS_ENV</code>
  (for distutils host packages), <code class="literal">PKG_PYTHON_SETUPTOOLS_ENV</code> (for
  setuptools target packages) and <code class="literal">HOST_PKG_PYTHON_SETUPTOOLS_ENV</code>
  (for setuptools host packages).
</li><li class="listitem">
<code class="literal">PYTHON_FOO_BUILD_OPTS</code>, to specify additional options to pass to the
  Python <code class="literal">setup.py</code> script during the build step. For target distutils
  packages, the <code class="literal">PKG_PYTHON_DISTUTILS_BUILD_OPTS</code> options are already
  passed automatically by the infrastructure.
</li><li class="listitem">
<code class="literal">PYTHON_FOO_INSTALL_TARGET_OPTS</code>, <code class="literal">PYTHON_FOO_INSTALL_STAGING_OPTS</code>,
  <code class="literal">HOST_PYTHON_FOO_INSTALL_OPTS</code> to specify additional options to pass
  to the Python <code class="literal">setup.py</code> script during the target installation step,
  the staging installation step or the host installation,
  respectively. Note that the infrastructure is automatically passing
  some options, defined in <code class="literal">PKG_PYTHON_DISTUTILS_INSTALL_TARGET_OPTS</code>
  or <code class="literal">PKG_PYTHON_DISTUTILS_INSTALL_STAGING_OPTS</code> (for target distutils
  packages), <code class="literal">HOST_PKG_PYTHON_DISTUTILS_INSTALL_OPTS</code> (for host
  distutils packages), <code class="literal">PKG_PYTHON_SETUPTOOLS_INSTALL_TARGET_OPTS</code> or
  <code class="literal">PKG_PYTHON_SETUPTOOLS_INSTALL_STAGING_OPTS</code> (for target setuptools
  packages) and <code class="literal">HOST_PKG_PYTHON_SETUPTOOLS_INSTALL_OPTS</code> (for host
  setuptools packages).
</li></ul></div><p>With the Python infrastructure, all the steps required to build and
install the packages are already defined, and they generally work well
for most Python-based packages. However, when required, it is still
possible to customize what is done in any particular step:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
By adding a post-operation hook (after extract, patch, configure,
  build or install). See <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for details.
</li><li class="listitem">
By overriding one of the steps. For example, even if the Python
  infrastructure is used, if the package <code class="literal">.mk</code> file defines its own
  <code class="literal">PYTHON_FOO_BUILD_CMDS</code> variable, it will be used instead of the
  default Python one. However, using this method should be restricted
  to very specific cases. Do not use it in the general case.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="scanpypi"></a>18.9.3. Generating a <code class="literal">python-package</code> from a PyPI repository</h3></div></div></div><p>If the Python package for which you would like to create a Buildroot
package is available on PyPI, you may want to use the <code class="literal">scanpypi</code> tool
located in <code class="literal">utils/</code> to automate the process.</p><p>You can find the list of existing PyPI packages
<a class="ulink" href="https://pypi.python.org" target="_top">here</a>.</p><p><code class="literal">scanpypi</code> requires Python’s <code class="literal">setuptools</code> package to be installed on
your host.</p><p>When at the root of your buildroot directory just do :</p><pre class="screen">utils/scanpypi foo bar -o package</pre><p>This will generate packages <code class="literal">python-foo</code> and <code class="literal">python-bar</code> in the package
folder if they exist on <a class="ulink" href="https://pypi.python.org" target="_top">https://pypi.python.org</a>.</p><p>Find the <code class="literal">external python modules</code> menu and insert your package inside.
Keep in mind that the items inside a menu should be in alphabetical order.</p><p>Please keep in mind that you’ll most likely have to manually check the
package for any mistakes as there are things that cannot be guessed by
the generator (e.g.  dependencies on any of the python core modules
such as BR2_PACKAGE_PYTHON_ZLIB).  Also, please take note that the
license and license files are guessed and must be checked. You also
need to manually add the package to the <code class="literal">package/Config.in</code> file.</p><p>If your Buildroot package is not in the official Buildroot tree but in
a br2-external tree, use the -o flag as follows:</p><pre class="screen">utils/scanpypi foo bar -o other_package_dir</pre><p>This will generate packages <code class="literal">python-foo</code> and <code class="literal">python-bar</code> in the
<code class="literal">other_package_directory</code> instead of <code class="literal">package</code>.</p><p>Option <code class="literal">-h</code> will list the available options:</p><pre class="screen">utils/scanpypi -h</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="python-package-cffi-backend"></a>18.9.4. <code class="literal">python-package</code> CFFI backend</h3></div></div></div><p>C Foreign Function Interface for Python (CFFI) provides a convenient
and reliable way to call compiled C code from Python using interface
declarations written in C. Python packages relying on this backend can
be identified by the appearance of a <code class="literal">cffi</code> dependency in the
<code class="literal">install_requires</code> field of their <code class="literal">setup.py</code> file.</p><p>Such a package should:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
add <code class="literal">python-cffi</code> as a runtime dependency in order to install the
compiled C library wrapper on the target. This is achieved by adding
<code class="literal">select BR2_PACKAGE_PYTHON_CFFI</code> to the package <code class="literal">Config.in</code>.
</li></ul></div><pre class="screen">config BR2_PACKAGE_PYTHON_FOO
        bool "python-foo"
        select BR2_PACKAGE_PYTHON_CFFI # runtime</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
add <code class="literal">host-python-cffi</code> as a build-time dependency in order to
cross-compile the C wrapper. This is achieved by adding
<code class="literal">host-python-cffi</code> to the <code class="literal">PYTHON_FOO_DEPENDENCIES</code> variable.
</li></ul></div><pre class="screen">################################################################################
#
# python-foo
#
################################################################################

...

PYTHON_FOO_DEPENDENCIES = host-python-cffi

$(eval $(python-package))</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_luarocks_based_packages"></a>18.10. Infrastructure for LuaRocks-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="luarocks-package-tutorial"></a>18.10.1. <code class="literal">luarocks-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a LuaRocks-based package,
with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # lua-foo
04: #
05: ################################################################################
06:
07: LUA_FOO_VERSION = 1.0.2-1
08: LUA_FOO_NAME_UPSTREAM = foo
09: LUA_FOO_DEPENDENCIES = bar
10:
11: LUA_FOO_BUILD_OPTS += BAR_INCDIR=$(STAGING_DIR)/usr/include
12: LUA_FOO_BUILD_OPTS += BAR_LIBDIR=$(STAGING_DIR)/usr/lib
13: LUA_FOO_LICENSE = luaFoo license
14: LUA_FOO_LICENSE_FILES = $(LUA_FOO_SUBDIR)/COPYING
15:
16: $(eval $(luarocks-package))</pre><p>On line 7, we declare the version of the package (the same as in the rockspec,
which is the concatenation of the upstream version and the rockspec revision,
separated by a hyphen <span class="emphasis"><em>-</em></span>).</p><p>On line 8, we declare that the package is called "foo" on LuaRocks. In
Buildroot, we give Lua-related packages a name that starts with "lua", so the
Buildroot name is different from the upstream name. <code class="literal">LUA_FOO_NAME_UPSTREAM</code>
makes the link between the two names.</p><p>On line 9, we declare our dependencies against native libraries, so that they
are built before the build process of our package starts.</p><p>On lines 11-12, we tell Buildroot to pass custom options to LuaRocks when it is
building the package.</p><p>On lines 13-14, we specify the licensing terms for the package.</p><p>Finally, on line 16, we invoke the <code class="literal">luarocks-package</code>
macro that generates all the Makefile rules that actually allows the
package to be built.</p><p>Most of these details can be retrieved from the <code class="literal">rock</code> and <code class="literal">rockspec</code>.
So, this file and the Config.in file can be generated by running the
command <code class="literal">luarocks buildroot foo lua-foo</code> in the Buildroot
directory. This command runs a specific Buildroot addon of <code class="literal">luarocks</code>
that will automatically generate a Buildroot package. The result must
still be manually inspected and possibly modified.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">package/Config.in</code> file has to be updated manually to include the
  generated Config.in files.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="luarocks-package-reference"></a>18.10.2. <code class="literal">luarocks-package</code> reference</h3></div></div></div><p>LuaRocks is a deployment and management system for Lua modules, and supports
various <code class="literal">build.type</code>: <code class="literal">builtin</code>, <code class="literal">make</code> and <code class="literal">cmake</code>. In the context of
Buildroot, the <code class="literal">luarocks-package</code> infrastructure only supports the <code class="literal">builtin</code>
mode. LuaRocks packages that use the <code class="literal">make</code> or <code class="literal">cmake</code> build mechanisms
should instead be packaged using the <code class="literal">generic-package</code> and <code class="literal">cmake-package</code>
infrastructures in Buildroot, respectively.</p><p>The main macro of the LuaRocks package infrastructure is <code class="literal">luarocks-package</code>:
like <code class="literal">generic-package</code> it works by defining a number of variables providing
metadata information about the package, and then calling <code class="literal">luarocks-package</code>.</p><p>Just like the generic infrastructure, the LuaRocks infrastructure works
by defining a number of variables before calling the <code class="literal">luarocks-package</code>
macro.</p><p>First, all the package metadata information variables that exist in
the generic infrastructure also exist in the LuaRocks infrastructure:
<code class="literal">LUA_FOO_VERSION</code>, <code class="literal">LUA_FOO_SOURCE</code>, <code class="literal">LUA_FOO_SITE</code>,
<code class="literal">LUA_FOO_DEPENDENCIES</code>, <code class="literal">LUA_FOO_LICENSE</code>, <code class="literal">LUA_FOO_LICENSE_FILES</code>.</p><p>Two of them are populated by the LuaRocks infrastructure (for the
<code class="literal">download</code> step). If your package is not hosted on the LuaRocks mirror
<code class="literal">$(BR2_LUAROCKS_MIRROR)</code>, you can override them:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LUA_FOO_SITE</code>, which defaults to <code class="literal">$(BR2_LUAROCKS_MIRROR)</code>
</li><li class="listitem">
<code class="literal">LUA_FOO_SOURCE</code>, which defaults to
  <code class="literal">$(lowercase LUA_FOO_NAME_UPSTREAM)-$(LUA_FOO_VERSION).src.rock</code>
</li></ul></div><p>A few additional variables, specific to the LuaRocks infrastructure, are
also defined. They can be overridden in specific cases.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LUA_FOO_NAME_UPSTREAM</code>, which defaults to <code class="literal">lua-foo</code>, i.e. the Buildroot
  package name
</li><li class="listitem">
<code class="literal">LUA_FOO_ROCKSPEC</code>, which defaults to
  <code class="literal">$(lowercase LUA_FOO_NAME_UPSTREAM)-$(LUA_FOO_VERSION).rockspec</code>
</li><li class="listitem">
<code class="literal">LUA_FOO_SUBDIR</code>, which defaults to
  <code class="literal">$(LUA_FOO_NAME_UPSTREAM)-$(LUA_FOO_VERSION_WITHOUT_ROCKSPEC_REVISION)</code>
</li><li class="listitem">
<code class="literal">LUA_FOO_BUILD_OPTS</code> contains additional build options for the
  <code class="literal">luarocks build</code> call.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_perl_cpan_packages"></a>18.11. Infrastructure for Perl/CPAN packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="perl-package-tutorial"></a>18.11.1. <code class="literal">perl-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a Perl/CPAN package,
with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # perl-foo-bar
04: #
05: ################################################################################
06:
07: PERL_FOO_BAR_VERSION = 0.02
08: PERL_FOO_BAR_SOURCE = Foo-Bar-$(PERL_FOO_BAR_VERSION).tar.gz
09: PERL_FOO_BAR_SITE = $(BR2_CPAN_MIRROR)/authors/id/M/MO/MONGER
10: PERL_FOO_BAR_DEPENDENCIES = perl-strictures
11: PERL_FOO_BAR_LICENSE = Artistic or GPL-1.0+
12: PERL_FOO_BAR_LICENSE_FILES = LICENSE
13: PERL_FOO_BAR_DISTNAME = Foo-Bar
14:
15: $(eval $(perl-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball and the location
of the tarball on a CPAN server. Buildroot will automatically download
the tarball from this location.</p><p>On line 10, we declare our dependencies, so that they are built
before the build process of our package starts.</p><p>On line 11 and 12, we give licensing details about the package (its
license on line 11, and the file containing the license text on line
12).</p><p>On line 13, the name of the distribution as needed by the script
<code class="literal">utils/scancpan</code> (in order to regenerate/upgrade these package files).</p><p>Finally, on line 15, we invoke the <code class="literal">perl-package</code> macro that
generates all the Makefile rules that actually allow the package to be
built.</p><p>Most of these data can be retrieved from <a class="ulink" href="https://metacpan.org/" target="_top">https://metacpan.org/</a>.
So, this file and the Config.in can be generated by running
the script <code class="literal">utils/scancpan Foo-Bar</code> in the Buildroot directory
(or in a br2-external tree).
This script creates a Config.in file and foo-bar.mk file for the
requested package, and also recursively for all dependencies specified by
CPAN. You should still manually edit the result. In particular, the
following things should be checked.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the perl module links with a shared library that is provided by
  another (non-perl) package, this dependency is not added automatically.
  It has to be added manually to <code class="literal">PERL_FOO_BAR_DEPENDENCIES</code>.
</li><li class="listitem">
The <code class="literal">package/Config.in</code> file has to be updated manually to include the
  generated Config.in files. As a hint, the <code class="literal">scancpan</code> script prints out
  the required <code class="literal">source "…"</code> statements, sorted alphabetically.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="perl-package-reference"></a>18.11.2. <code class="literal">perl-package</code> reference</h3></div></div></div><p>As a policy, packages that provide Perl/CPAN modules should all be
named <code class="literal">perl-&lt;something&gt;</code> in Buildroot.</p><p>This infrastructure handles various Perl build systems :
<code class="literal">ExtUtils-MakeMaker</code> (EUMM), <code class="literal">Module-Build</code> (MB) and <code class="literal">Module-Build-Tiny</code>.
<code class="literal">Build.PL</code> is preferred by default when a package provides a <code class="literal">Makefile.PL</code>
and a <code class="literal">Build.PL</code>.</p><p>The main macro of the Perl/CPAN package infrastructure is
<code class="literal">perl-package</code>. It is similar to the <code class="literal">generic-package</code> macro. The ability to
have target and host packages is also available, with the
<code class="literal">host-perl-package</code> macro.</p><p>Just like the generic infrastructure, the Perl/CPAN infrastructure
works by defining a number of variables before calling the
<code class="literal">perl-package</code> macro.</p><p>First, all the package metadata information variables that exist in the
generic infrastructure also exist in the Perl/CPAN infrastructure:
<code class="literal">PERL_FOO_VERSION</code>, <code class="literal">PERL_FOO_SOURCE</code>,
<code class="literal">PERL_FOO_PATCH</code>, <code class="literal">PERL_FOO_SITE</code>,
<code class="literal">PERL_FOO_SUBDIR</code>, <code class="literal">PERL_FOO_DEPENDENCIES</code>,
<code class="literal">PERL_FOO_INSTALL_TARGET</code>.</p><p>Note that setting <code class="literal">PERL_FOO_INSTALL_STAGING</code> to <code class="literal">YES</code> has no effect
unless a <code class="literal">PERL_FOO_INSTALL_STAGING_CMDS</code> variable is defined. The perl
infrastructure doesn’t define these commands since Perl modules generally
don’t need to be installed to the <code class="literal">staging</code> directory.</p><p>A few additional variables, specific to the Perl/CPAN infrastructure,
can also be defined. Many of them are only useful in very specific
cases, typical packages will therefore only use a few of them.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">PERL_FOO_PREFER_INSTALLER</code>/<code class="literal">HOST_PERL_FOO_PREFER_INSTALLER</code>,
  specifies the preferred installation method. Possible values are
  <code class="literal">EUMM</code> (for <code class="literal">Makefile.PL</code> based installation using
  <code class="literal">ExtUtils-MakeMaker</code>) and <code class="literal">MB</code> (for <code class="literal">Build.PL</code> based installation
  using <code class="literal">Module-Build</code>). This variable is only used when the package
  provides both installation methods.
</li><li class="listitem">
<code class="literal">PERL_FOO_CONF_ENV</code>/<code class="literal">HOST_PERL_FOO_CONF_ENV</code>, to specify additional
  environment variables to pass to the <code class="literal">perl Makefile.PL</code> or <code class="literal">perl Build.PL</code>.
  By default, empty.
</li><li class="listitem">
<code class="literal">PERL_FOO_CONF_OPTS</code>/<code class="literal">HOST_PERL_FOO_CONF_OPTS</code>, to specify additional
  configure options to pass to the <code class="literal">perl Makefile.PL</code> or <code class="literal">perl Build.PL</code>.
  By default, empty.
</li><li class="listitem">
<code class="literal">PERL_FOO_BUILD_OPTS</code>/<code class="literal">HOST_PERL_FOO_BUILD_OPTS</code>, to specify additional
  options to pass to <code class="literal">make pure_all</code> or <code class="literal">perl Build build</code> in the build step.
  By default, empty.
</li><li class="listitem">
<code class="literal">PERL_FOO_INSTALL_TARGET_OPTS</code>, to specify additional options to
  pass to <code class="literal">make pure_install</code> or <code class="literal">perl Build install</code> in the install step.
  By default, empty.
</li><li class="listitem">
<code class="literal">HOST_PERL_FOO_INSTALL_OPTS</code>, to specify additional options to
  pass to <code class="literal">make pure_install</code> or <code class="literal">perl Build install</code> in the install step.
  By default, empty.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_virtual_packages"></a>18.12. Infrastructure for virtual packages</h2></div></div></div><p><a id="virtual-package-tutorial"></a>In Buildroot, a virtual package is a package whose functionalities are
provided by one or more packages, referred to as <span class="emphasis"><em>providers</em></span>. The virtual
package management is an extensible mechanism allowing the user to choose
the provider used in the rootfs.</p><p>For example, <span class="emphasis"><em>OpenGL ES</em></span> is an API for 2D and 3D graphics on embedded systems.
The implementation of this API is different for the <span class="emphasis"><em>Allwinner Tech Sunxi</em></span> and
the <span class="emphasis"><em>Texas Instruments OMAP35xx</em></span> platforms. So <code class="literal">libgles</code> will be a virtual
package and <code class="literal">sunxi-mali-utgard</code> and <code class="literal">ti-gfx</code> will be the providers.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_literal_virtual_package_literal_tutorial"></a>18.12.1. <code class="literal">virtual-package</code> tutorial</h3></div></div></div><p>In the following example, we will explain how to add a new virtual package
(<span class="emphasis"><em>something-virtual</em></span>) and a provider for it (<span class="emphasis"><em>some-provider</em></span>).</p><p>First, let’s create the virtual package.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_virtual_package_8217_s_literal_config_in_literal_file"></a>18.12.2. Virtual package’s <code class="literal">Config.in</code> file</h3></div></div></div><p>The <code class="literal">Config.in</code> file of virtual package <span class="emphasis"><em>something-virtual</em></span> should contain:</p><pre class="screen">01: config BR2_PACKAGE_HAS_SOMETHING_VIRTUAL
02:     bool
03:
04: config BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL
05:     depends on BR2_PACKAGE_HAS_SOMETHING_VIRTUAL
06:     string</pre><p>In this file, we declare two options, <code class="literal">BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</code> and
<code class="literal">BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL</code>, whose values will be used by the
providers.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_virtual_package_8217_s_literal_mk_literal_file"></a>18.12.3. Virtual package’s <code class="literal">.mk</code> file</h3></div></div></div><p>The <code class="literal">.mk</code> for the virtual package should just evaluate the <code class="literal">virtual-package</code> macro:</p><pre class="screen">01: ################################################################################
02: #
03: # something-virtual
04: #
05: ################################################################################
06:
07: $(eval $(virtual-package))</pre><p>The ability to have target and host packages is also available, with the
<code class="literal">host-virtual-package</code> macro.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_provider_8217_s_literal_config_in_literal_file"></a>18.12.4. Provider’s <code class="literal">Config.in</code> file</h3></div></div></div><p>When adding a package as a provider, only the <code class="literal">Config.in</code> file requires some
modifications.</p><p>The <code class="literal">Config.in</code> file of the package <span class="emphasis"><em>some-provider</em></span>, which provides the
functionalities of <span class="emphasis"><em>something-virtual</em></span>, should contain:</p><pre class="screen">01: config BR2_PACKAGE_SOME_PROVIDER
02:     bool "some-provider"
03:     select BR2_PACKAGE_HAS_SOMETHING_VIRTUAL
04:     help
05:       This is a comment that explains what some-provider is.
06:
07:       http://foosoftware.org/some-provider/
08:
09: if BR2_PACKAGE_SOME_PROVIDER
10: config BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL
11:     default "some-provider"
12: endif</pre><p>On line 3, we select <code class="literal">BR2_PACKAGE_HAS_SOMETHING_VIRTUAL</code>, and on line 11, we
set the value of <code class="literal">BR2_PACKAGE_PROVIDES_SOMETHING_VIRTUAL</code> to the name of the
provider, but only if it is selected.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_provider_8217_s_literal_mk_literal_file"></a>18.12.5. Provider’s <code class="literal">.mk</code> file</h3></div></div></div><p>The <code class="literal">.mk</code> file should also declare an additional variable
<code class="literal">SOME_PROVIDER_PROVIDES</code> to contain the names of all the virtual
packages it is an implementation of:</p><pre class="screen">01: SOME_PROVIDER_PROVIDES = something-virtual</pre><p>Of course, do not forget to add the proper build and runtime dependencies for
this package!</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_notes_on_depending_on_a_virtual_package"></a>18.12.6. Notes on depending on a virtual package</h3></div></div></div><p>When adding a package that requires a certain <code class="literal">FEATURE</code> provided by a virtual
package, you have to use <code class="literal">depends on BR2_PACKAGE_HAS_FEATURE</code>, like so:</p><pre class="screen">config BR2_PACKAGE_HAS_FEATURE
    bool

config BR2_PACKAGE_FOO
    bool "foo"
    depends on BR2_PACKAGE_HAS_FEATURE</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_notes_on_depending_on_a_specific_provider"></a>18.12.7. Notes on depending on a specific provider</h3></div></div></div><p>If your package really requires a specific provider, then you’ll have to
make your package <code class="literal">depends on</code> this provider; you can <span class="emphasis"><em>not</em></span> <code class="literal">select</code> a
provider.</p><p>Let’s take an example with two providers for a <code class="literal">FEATURE</code>:</p><pre class="screen">config BR2_PACKAGE_HAS_FEATURE
    bool

config BR2_PACKAGE_FOO
    bool "foo"
    select BR2_PACKAGE_HAS_FEATURE

config BR2_PACKAGE_BAR
    bool "bar"
    select BR2_PACKAGE_HAS_FEATURE</pre><p>And you are adding a package that needs <code class="literal">FEATURE</code> as provided by <code class="literal">foo</code>,
but not as provided by <code class="literal">bar</code>.</p><p>If you were to use <code class="literal">select BR2_PACKAGE_FOO</code>, then the user would still
be able to select <code class="literal">BR2_PACKAGE_BAR</code> in the menuconfig. This would create
a configuration inconsistency, whereby two providers of the same <code class="literal">FEATURE</code>
would be enabled at once, one explicitly set by the user, the other
implicitly by your <code class="literal">select</code>.</p><p>Instead, you have to use <code class="literal">depends on BR2_PACKAGE_FOO</code>, which avoids any
implicit configuration inconsistency.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_packages_using_kconfig_for_configuration_files"></a>18.13. Infrastructure for packages using kconfig for configuration files</h2></div></div></div><p>A popular way for a software package to handle user-specified
configuration is <code class="literal">kconfig</code>. Among others, it is used by the Linux
kernel, Busybox, and Buildroot itself. The presence of a .config file
and a <code class="literal">menuconfig</code> target are two well-known symptoms of kconfig being
used.</p><p>Buildroot features an infrastructure for packages that use kconfig for
their configuration. This infrastructure provides the necessary logic to
expose the package’s <code class="literal">menuconfig</code> target as <code class="literal">foo-menuconfig</code> in
Buildroot, and to handle the copying back and forth of the configuration
file in a correct way.</p><p>The <code class="literal">kconfig-package</code> infrastructure is based on the <code class="literal">generic-package</code>
infrastructure. All variables supported by <code class="literal">generic-package</code> are
available in <code class="literal">kconfig-package</code> as well. See
<a class="xref" href="ch18.html#generic-package-reference" title="18.6.2. generic-package reference">Section 18.6.2, “<code class="literal">generic-package</code> reference”</a> for more details.</p><p>In order to use the <code class="literal">kconfig-package</code> infrastructure for a Buildroot
package, the minimally required lines in the <code class="literal">.mk</code> file, in addition to
the variables required by the <code class="literal">generic-package</code> infrastructure, are:</p><pre class="screen">FOO_KCONFIG_FILE = reference-to-source-configuration-file

$(eval $(kconfig-package))</pre><p>This snippet creates the following make targets:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">foo-menuconfig</code>, which calls the package’s <code class="literal">menuconfig</code> target
</li><li class="listitem">
<code class="literal">foo-update-config</code>, which copies the configuration back to the
  source configuration file. It is not possible to use this target
  when fragment files are set.
</li><li class="listitem">
<code class="literal">foo-update-defconfig</code>, which copies the configuration back to the
  source configuration file. The configuration file will only list the
  options that differ from the default values. It is not possible to
  use this target when fragment files are set.
</li><li class="listitem">
<code class="literal">foo-diff-config</code>, which outputs the differences between the current
  configuration and the one defined in the Buildroot configuration for
  this kconfig package. The output is useful to identify the
  configuration changes that may have to be propagated to
  configuration fragments for example.
</li></ul></div><p>and ensures that the source configuration file is copied to the build
directory at the right moment.</p><p>There are two options to specify a configuration file to use, either
<code class="literal">FOO_KCONFIG_FILE</code> (as in the example, above) or <code class="literal">FOO_KCONFIG_DEFCONFIG</code>.
It is mandatory to provide either, but not both:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_KCONFIG_FILE</code> specifies the path to a defconfig or full-config file
  to be used to configure the package.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_DEFCONFIG</code> specifies the defconfig <span class="emphasis"><em>make</em></span> rule to call to
  configure the package.
</li></ul></div><p>In addition to these minimally required lines, several optional variables can
be set to suit the needs of the package under consideration:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_KCONFIG_EDITORS</code>: a space-separated list of kconfig editors to
  support, for example <span class="emphasis"><em>menuconfig xconfig</em></span>. By default, <span class="emphasis"><em>menuconfig</em></span>.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_FRAGMENT_FILES</code>: a space-separated list of configuration
  fragment files that are merged to the main configuration file.
  Fragment files are typically used when there is a desire to stay in sync
  with an upstream (def)config file, with some minor modifications.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_OPTS</code>: extra options to pass when calling the kconfig
  editors. This may need to include <span class="emphasis"><em>$(FOO_MAKE_OPTS)</em></span>, for example. By
  default, empty.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_FIXUP_CMDS</code>: a list of shell commands needed to fixup the
  configuration file after copying it or running a kconfig editor. Such
  commands may be needed to ensure a configuration consistent with other
  configuration of Buildroot, for example. By default, empty.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_DOTCONFIG</code>: path (with filename) of the <code class="literal">.config</code> file,
  relative to the package source tree. The default, <code class="literal">.config</code>, should
  be well suited for all packages that use the standard kconfig
  infrastructure as inherited from the Linux kernel; some packages use
  a derivative of kconfig that use a different location.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_DEPENDENCIES</code>: the list of packages (most probably, host
  packages) that need to be built before this package’s kconfig is
  interpreted. Seldom used. By default, empty.
</li><li class="listitem">
<code class="literal">FOO_KCONFIG_SUPPORTS_DEFCONFIG</code>: whether the package’s kconfig system
  supports using defconfig files; few packages do not. By default, <span class="emphasis"><em>YES</em></span>.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_rebar_based_packages"></a>18.14. Infrastructure for rebar-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rebar-package-tutorial"></a>18.14.1. <code class="literal">rebar-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a rebar-based package,
with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # erlang-foobar
04: #
05: ################################################################################
06:
07: ERLANG_FOOBAR_VERSION = 1.0
08: ERLANG_FOOBAR_SOURCE = erlang-foobar-$(ERLANG_FOOBAR_VERSION).tar.xz
09: ERLANG_FOOBAR_SITE = http://www.foosoftware.org/download
10: ERLANG_FOOBAR_DEPENDENCIES = host-libaaa libbbb
11:
12: $(eval $(rebar-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball
recommended) and the location of the tarball on the Web. Buildroot
will automatically download the tarball from this location.</p><p>On line 10, we declare our dependencies, so that they are built
before the build process of our package starts.</p><p>Finally, on line 12, we invoke the <code class="literal">rebar-package</code> macro that
generates all the Makefile rules that actually allows the package to
be built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rebar-package-reference"></a>18.14.2. <code class="literal">rebar-package</code> reference</h3></div></div></div><p>The main macro of the <code class="literal">rebar</code> package infrastructure is
<code class="literal">rebar-package</code>. It is similar to the <code class="literal">generic-package</code> macro. The
ability to have host packages is also available, with the
<code class="literal">host-rebar-package</code> macro.</p><p>Just like the generic infrastructure, the <code class="literal">rebar</code> infrastructure works
by defining a number of variables before calling the <code class="literal">rebar-package</code>
macro.</p><p>First, all the package metadata information variables that exist in
the generic infrastructure also exist in the <code class="literal">rebar</code> infrastructure:
<code class="literal">ERLANG_FOOBAR_VERSION</code>, <code class="literal">ERLANG_FOOBAR_SOURCE</code>,
<code class="literal">ERLANG_FOOBAR_PATCH</code>, <code class="literal">ERLANG_FOOBAR_SITE</code>,
<code class="literal">ERLANG_FOOBAR_SUBDIR</code>, <code class="literal">ERLANG_FOOBAR_DEPENDENCIES</code>,
<code class="literal">ERLANG_FOOBAR_INSTALL_STAGING</code>, <code class="literal">ERLANG_FOOBAR_INSTALL_TARGET</code>,
<code class="literal">ERLANG_FOOBAR_LICENSE</code> and <code class="literal">ERLANG_FOOBAR_LICENSE_FILES</code>.</p><p>A few additional variables, specific to the <code class="literal">rebar</code> infrastructure,
can also be defined. Many of them are only useful in very specific
cases, typical packages will therefore only use a few of them.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
<code class="literal">ERLANG_FOOBAR_USE_AUTOCONF</code>, to specify that the package uses
  <span class="emphasis"><em>autoconf</em></span> at the configuration step.  When a package sets this
  variable to <code class="literal">YES</code>, the <code class="literal">autotools</code> infrastructure is used.
</p><p><strong>Note. </strong>You can also use some of the variables from the <code class="literal">autotools</code>
  infrastructure: <code class="literal">ERLANG_FOOBAR_CONF_ENV</code>, <code class="literal">ERLANG_FOOBAR_CONF_OPTS</code>,
  <code class="literal">ERLANG_FOOBAR_AUTORECONF</code>, <code class="literal">ERLANG_FOOBAR_AUTORECONF_ENV</code> and
  <code class="literal">ERLANG_FOOBAR_AUTORECONF_OPTS</code>.</p></li><li class="listitem"><p class="simpara">
<code class="literal">ERLANG_FOOBAR_USE_BUNDLED_REBAR</code>, to specify that the package has
  a bundled version of <span class="emphasis"><em>rebar</em></span> <span class="strong"><strong>and</strong></span> that it shall be used. Valid
  values are <code class="literal">YES</code> or <code class="literal">NO</code> (the default).
</p><p><strong>Note. </strong>If the package bundles a <span class="emphasis"><em>rebar</em></span> utility, but can use the generic
  one that Buildroot provides, just say <code class="literal">NO</code> (i.e., do not specify
  this variable). Only set if it is mandatory to use the <span class="emphasis"><em>rebar</em></span>
  utility bundled in this package.</p></li><li class="listitem">
<code class="literal">ERLANG_FOOBAR_REBAR_ENV</code>, to specify additional environment
  variables to pass to the <span class="emphasis"><em>rebar</em></span> utility.
</li><li class="listitem">
<code class="literal">ERLANG_FOOBAR_KEEP_DEPENDENCIES</code>, to keep the dependencies
  described in the rebar.config file. Valid values are <code class="literal">YES</code> or <code class="literal">NO</code>
  (the default). Unless this variable is set to <code class="literal">YES</code>, the <span class="emphasis"><em>rebar</em></span>
  infrastructure removes such dependencies in a post-patch hook to
  ensure rebar does not download nor compile them.
</li></ul></div><p>With the rebar infrastructure, all the steps required to build
and install the packages are already defined, and they generally work
well for most rebar-based packages. However, when required, it is
still possible to customize what is done in any particular step:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
By adding a post-operation hook (after extract, patch, configure,
  build or install). See <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for details.
</li><li class="listitem">
By overriding one of the steps. For example, even if the rebar
  infrastructure is used, if the package <code class="literal">.mk</code> file defines its
  own <code class="literal">ERLANG_FOOBAR_BUILD_CMDS</code> variable, it will be used instead
  of the default rebar one. However, using this method should be
  restricted to very specific cases. Do not use it in the general
  case.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_waf_based_packages"></a>18.15. Infrastructure for Waf-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="waf-package-tutorial"></a>18.15.1. <code class="literal">waf-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a Waf-based package, with
an example :</p><pre class="screen">01: ################################################################################
02: #
03: # libfoo
04: #
05: ################################################################################
06:
07: LIBFOO_VERSION = 1.0
08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz
09: LIBFOO_SITE = http://www.foosoftware.org/download
10: LIBFOO_CONF_OPTS = --enable-bar --disable-baz
11: LIBFOO_DEPENDENCIES = bar
12:
13: $(eval $(waf-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball
recommended) and the location of the tarball on the Web. Buildroot
will automatically download the tarball from this location.</p><p>On line 10, we tell Buildroot what options to enable for libfoo.</p><p>On line 11, we tell Buildroot the dependencies of libfoo.</p><p>Finally, on line line 13, we invoke the <code class="literal">waf-package</code>
macro that generates all the Makefile rules that actually allows the
package to be built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="waf-package-reference"></a>18.15.2. <code class="literal">waf-package</code> reference</h3></div></div></div><p>The main macro of the Waf package infrastructure is <code class="literal">waf-package</code>.
It is similar to the <code class="literal">generic-package</code> macro.</p><p>Just like the generic infrastructure, the Waf infrastructure works
by defining a number of variables before calling the <code class="literal">waf-package</code>
macro.</p><p>First, all the package metadata information variables that exist in
the generic infrastructure also exist in the Waf infrastructure:
<code class="literal">LIBFOO_VERSION</code>, <code class="literal">LIBFOO_SOURCE</code>, <code class="literal">LIBFOO_PATCH</code>, <code class="literal">LIBFOO_SITE</code>,
<code class="literal">LIBFOO_SUBDIR</code>, <code class="literal">LIBFOO_DEPENDENCIES</code>, <code class="literal">LIBFOO_INSTALL_STAGING</code>,
<code class="literal">LIBFOO_INSTALL_TARGET</code>.</p><p>An additional variable, specific to the Waf infrastructure, can
also be defined.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LIBFOO_SUBDIR</code> may contain the name of a subdirectory inside the
  package that contains the main wscript file. This is useful,
  if for example, the main wscript file is not at the root of
  the tree extracted by the tarball. If <code class="literal">HOST_LIBFOO_SUBDIR</code> is not
  specified, it defaults to <code class="literal">LIBFOO_SUBDIR</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_NEEDS_EXTERNAL_WAF</code> can be set to <code class="literal">YES</code> or <code class="literal">NO</code> to tell
  Buildroot to use the bundled <code class="literal">waf</code> executable. If set to <code class="literal">NO</code>, the
  default, then Buildroot will use the waf executable provided in the
  package source tree; if set to <code class="literal">YES</code>, then Buildroot will download,
  install waf as a host tool and use it to build the package.
</li><li class="listitem">
<code class="literal">LIBFOO_WAF_OPTS</code>, to specify additional options to pass to the
  <code class="literal">waf</code> script at every step of the package build process: configure,
  build and installation. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_CONF_OPTS</code>, to specify additional options to pass to the
  <code class="literal">waf</code> script for the configuration step. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_BUILD_OPTS</code>, to specify additional options to pass to the
  <code class="literal">waf</code> script during the build step. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_STAGING_OPTS</code>, to specify additional options to pass
  to the <code class="literal">waf</code> script during the staging installation step.  By default,
  empty.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_TARGET_OPTS</code>, to specify additional options to pass
  to the <code class="literal">waf</code> script during the target installation step.  By default,
  empty.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_meson_based_packages"></a>18.16. Infrastructure for Meson-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="meson-package-tutorial"></a>18.16.1. <code class="literal">meson-package</code> tutorial</h3></div></div></div><p><a class="ulink" href="http://mesonbuild.com" target="_top">Meson</a> is an open source build system meant to be both
extremely fast, and, even more importantly, as user friendly as possible. It
uses <a class="ulink" href="https://ninja-build.org" target="_top">Ninja</a> as a companion tool to perform the actual
build operations.</p><p>Let’s see how to write a <code class="literal">.mk</code> file for a Meson-based package, with an example:</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: FOO_VERSION = 1.0
08: FOO_SOURCE = foo-$(FOO_VERSION).tar.gz
09: FOO_SITE = http://www.foosoftware.org/download
10: FOO_LICENSE = GPL-3.0+
11: FOO_LICENSE_FILES = COPYING
12: FOO_INSTALL_STAGING = YES
13:
14: FOO_DEPENDENCIES = host-pkgconf bar
15:
16: ifeq ($(BR2_PACKAGE_BAZ),y)
17: FOO_CONF_OPTS += -Dbaz=true
18: FOO_DEPENDENCIES += baz
19: else
20: FOO_CONF_OPTS += -Dbaz=false
21: endif
22:
23: $(eval $(meson-package))</pre><p>The Makefile starts with the definition of the standard variables for package
declaration (lines 7 to 11).</p><p>On line line 23, we invoke the <code class="literal">meson-package</code> macro that generates all the
Makefile rules that actually allows the package to be built.</p><p>In the example, <code class="literal">host-pkgconf</code> and <code class="literal">bar</code> are declared as dependencies in
<code class="literal">FOO_DEPENDENCIES</code> at line 14 because the Meson build file of <code class="literal">foo</code> uses
<code class="literal">pkg-config</code> to determine the compilation flags and libraries of package <code class="literal">bar</code>.</p><p>Note that it is not necessary to add <code class="literal">host-meson</code> in the <code class="literal">FOO_DEPENDENCIES</code>
variable of a package, since this basic dependency is automatically added as
needed by the Meson package infrastructure.</p><p>If the "baz" package is selected, then support for the "baz" feature in "foo" is
activated by adding <code class="literal">-Dbaz=true</code> to <code class="literal">FOO_CONF_OPTS</code> at line 17, as specified in
the <code class="literal">meson_options.txt</code> file in "foo" source tree. The "baz" package is also
added to <code class="literal">FOO_DEPENDENCIES</code>. Note that the support for <code class="literal">baz</code> is explicitly
disabled at line 20, if the package is not selected.</p><p>To sum it up, to add a new meson-based package, the Makefile example can be
copied verbatim then edited to replace all occurences of <code class="literal">FOO</code> with the
uppercase name of the new package and update the values of the standard
variables.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="meson-package-reference"></a>18.16.2. <code class="literal">meson-package</code> reference</h3></div></div></div><p>The main macro of the Meson package infrastructure is <code class="literal">meson-package</code>. It is
similar to the <code class="literal">generic-package</code> macro. The ability to have target and host
packages is also available, with the <code class="literal">host-meson-package</code> macro.</p><p>Just like the generic infrastructure, the Meson infrastructure works by defining
a number of variables before calling the <code class="literal">meson-package</code> macro.</p><p>First, all the package metadata information variables that exist in the generic
infrastructure also exist in the Meson infrastructure: <code class="literal">FOO_VERSION</code>,
<code class="literal">FOO_SOURCE</code>, <code class="literal">FOO_PATCH</code>, <code class="literal">FOO_SITE</code>, <code class="literal">FOO_SUBDIR</code>, <code class="literal">FOO_DEPENDENCIES</code>,
<code class="literal">FOO_INSTALL_STAGING</code>, <code class="literal">FOO_INSTALL_TARGET</code>.</p><p>A few additional variables, specific to the Meson infrastructure, can also be
defined. Many of them are only useful in very specific cases, typical packages
will therefore only use a few of them.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_SUBDIR</code> may contain the name of a subdirectory inside the
  package that contains the main meson.build file. This is useful,
  if for example, the main meson.build file is not at the root of
  the tree extracted by the tarball. If <code class="literal">HOST_FOO_SUBDIR</code> is not
  specified, it defaults to <code class="literal">FOO_SUBDIR</code>.
</li><li class="listitem">
<code class="literal">FOO_CONF_ENV</code>, to specify additional environment variables to pass to
  <code class="literal">meson</code> for the configuration step. By default, empty.
</li><li class="listitem">
<code class="literal">FOO_CONF_OPTS</code>, to specify additional options to pass to <code class="literal">meson</code> for the
  configuration step. By default, empty.
</li><li class="listitem">
<code class="literal">FOO_CFLAGS</code>, to specify compiler arguments added to the package specific
  <code class="literal">cross-compile.conf</code> file <code class="literal">c_args</code> property. By default, the value of
  <code class="literal">TARGET_CFLAGS</code>.
</li><li class="listitem">
<code class="literal">FOO_CXXFLAGS</code>, to specify compiler arguments added to the package specific
  <code class="literal">cross-compile.conf</code> file <code class="literal">cpp_args</code> property. By default, the value of
  <code class="literal">TARGET_CXXFLAGS</code>.
</li><li class="listitem">
<code class="literal">FOO_LDFLAGS</code>, to specify compiler arguments added to the package specific
  <code class="literal">cross-compile.conf</code> file <code class="literal">c_link_args</code> and <code class="literal">cpp_link_args</code> properties. By
  default, the value of <code class="literal">TARGET_LDFLAGS</code>.
</li><li class="listitem">
<code class="literal">FOO_MESON_EXTRA_BINARIES</code>, to specify a space-separated list of programs
  to add to the <code class="literal">[binaries]</code> section of the meson <code class="literal">cross-compilation.conf</code>
  configuration file. The format is <code class="literal">program-name='/path/to/program'</code>, with
  no space around the <code class="literal">=</code> sign, and with the path of the program between
  single quotes. By default, empty. Note that Buildroot already sets the
  correct values for <code class="literal">c</code>, <code class="literal">cpp</code>, <code class="literal">ar</code>, <code class="literal">strip</code>, and <code class="literal">pkgconfig</code>.
</li><li class="listitem">
<code class="literal">FOO_MESON_EXTRA_PROPERTIES</code>, to specify a space-separated list of
  properties to add to the <code class="literal">[properties]</code> section of the meson
  <code class="literal">cross-compilation.conf</code> configuration file. The format is
  <code class="literal">property-name=&lt;value&gt;</code> with no space around the <code class="literal">=</code> sign, and with
  single quotes around string values. By default, empty. Note that
  Buildroot already sets values for <code class="literal">needs_exe_wrapper</code>, <code class="literal">c_args</code>,
  <code class="literal">c_link_args</code>, <code class="literal">cpp_args</code>, <code class="literal">cpp_link_args</code>, <code class="literal">sys_root</code>, and
  <code class="literal">pkg_config_libdir</code>.
</li><li class="listitem">
<code class="literal">FOO_NINJA_ENV</code>, to specify additional environment variables to pass to
  <code class="literal">ninja</code>, meson companion tool in charge of the build operations. By default,
  empty.
</li><li class="listitem">
<code class="literal">FOO_NINJA_OPTS</code>, to specify a space-separated list of targets to build. By
  default, empty, to build the default target(s).
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_cargo_based_packages"></a>18.17. Infrastructure for Cargo-based packages</h2></div></div></div><p>Cargo is the package manager for the Rust programming language. It allows the
user to build programs or libraries written in Rust, but it also downloads and
manages their dependencies, to ensure repeatable builds. Cargo packages are
called "crates".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cargo-package-tutorial"></a>18.17.1. <code class="literal">cargo-package</code> tutorial</h3></div></div></div><p>The <code class="literal">Config.in</code> file of Cargo-based package <span class="emphasis"><em>foo</em></span> should contain:</p><pre class="screen">01: config BR2_PACKAGE_FOO
02:     bool "foo"
03:     depends on BR2_PACKAGE_HOST_RUSTC_TARGET_ARCH_SUPPORTS
04:     select BR2_PACKAGE_HOST_RUSTC
05:     help
06:       This is a comment that explains what foo is.
07:
08:       http://foosoftware.org/foo/</pre><p>And the <code class="literal">.mk</code> file for this package should contain:</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: FOO_VERSION = 1.0
08: FOO_SOURCE = foo-$(FOO_VERSION).tar.gz
09: FOO_SITE = http://www.foosoftware.org/download
10: FOO_LICENSE = GPL-3.0+
11: FOO_LICENSE_FILES = COPYING
12:
13: $(eval $(cargo-package))</pre><p>The Makefile starts with the definition of the standard variables for
package declaration (lines 7 to 11).</p><p>As seen in line 13, it is based on the <code class="literal">cargo-package</code>
infrastructure. Cargo will be invoked automatically by this
infrastructure to build and install the package.</p><p>It is still possible to define custom build commands or install
commands (i.e.  with FOO_BUILD_CMDS and FOO_INSTALL_TARGET_CMDS).
Those will then replace the commands from the cargo infrastructure.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_literal_cargo_package_literal_reference"></a>18.17.2. <code class="literal">cargo-package</code> reference</h3></div></div></div><p>The main macros for the Cargo package infrastructure are
<code class="literal">cargo-package</code> for target packages and <code class="literal">host-cargo-package</code> for host
packages.</p><p>Just like the generic infrastructure, the Cargo infrastructure works
by defining a number of variables before calling the <code class="literal">cargo-package</code>
or <code class="literal">host-cargo-package</code> macros.</p><p>First, all the package metadata information variables that exist in
the generic infrastructure also exist in the Cargo infrastructure:
<code class="literal">FOO_VERSION</code>, <code class="literal">FOO_SOURCE</code>, <code class="literal">FOO_PATCH</code>, <code class="literal">FOO_SITE</code>,
<code class="literal">FOO_DEPENDENCIES</code>, <code class="literal">FOO_LICENSE</code>, <code class="literal">FOO_LICENSE_FILES</code>, etc.</p><p>A few additional variables, specific to the Cargo infrastructure, can
also be defined. Many of them are only useful in very specific cases,
typical packages will therefore only use a few of them.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_SUBDIR</code> may contain the name of a subdirectory inside the package
  that contains the Cargo.toml file. This is useful, if for example, it
  is not at the root of the tree extracted by the tarball. If
  <code class="literal">HOST_FOO_SUBDIR</code> is not specified, it defaults to <code class="literal">FOO_SUBDIR</code>.
</li><li class="listitem">
<code class="literal">FOO_CARGO_ENV</code> can be used to pass additional variables in the
  environment of <code class="literal">cargo</code> invocations. It used at both build and
  installation time
</li><li class="listitem">
<code class="literal">FOO_CARGO_BUILD_OPTS</code> can be used to pass additional options to
  <code class="literal">cargo</code> at build time.
</li><li class="listitem">
<code class="literal">FOO_CARGO_INSTALL_OPTS</code> can be used to pass additional options to
  <code class="literal">cargo</code> at install time.
</li></ul></div><p>A crate can depend on other libraries from crates.io or git
repositories, listed in its <code class="literal">Cargo.toml</code> file. Buildroot automatically
takes care of downloading such dependencies as part of the download
step of packages that use the <code class="literal">cargo-package</code> infrastructure. Such
dependencies are then kept together with the package source code in
the tarball cached in Buildroot’s <code class="literal">DL_DIR</code>, and therefore the hash of
the package’s tarball includes such dependencies.</p><p>This mechanism ensures that any change in the dependencies will be
detected, and allows the build to be performed completely offline.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_go_packages"></a>18.18. Infrastructure for Go packages</h2></div></div></div><p>This infrastructure applies to Go packages that use the standard
build system and use bundled dependencies.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="golang-package-tutorial"></a>18.18.1. <code class="literal">golang-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a go package,
with an example :</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: FOO_VERSION = 1.0
08: FOO_SITE = $(call github,bar,foo,$(FOO_VERSION))
09: FOO_LICENSE = BSD-3-Clause
10: FOO_LICENSE_FILES = LICENSE
11:
12: $(eval $(golang-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8, we declare the upstream location of the package, here
fetched from Github, since a large number of Go packages are hosted on
Github.</p><p>On line 9 and 10, we give licensing details about the package.</p><p>Finally, on line 12, we invoke the <code class="literal">golang-package</code> macro that
generates all the Makefile rules that actually allow the package to be
built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="golang-package-reference"></a>18.18.2. <code class="literal">golang-package</code> reference</h3></div></div></div><p>In their <code class="literal">Config.in</code> file, packages using the <code class="literal">golang-package</code>
infrastructure should depend on <code class="literal">BR2_PACKAGE_HOST_GO_TARGET_ARCH_SUPPORTS</code>
because Buildroot will automatically add a dependency on <code class="literal">host-go</code>
to such packages.
If you need CGO support in your package, you must add a dependency on
<code class="literal">BR2_PACKAGE_HOST_GO_TARGET_CGO_LINKING_SUPPORTS</code>.</p><p>The main macro of the Go package infrastructure is
<code class="literal">golang-package</code>. It is similar to the <code class="literal">generic-package</code> macro. The
ability to build host packages is also available, with the
<code class="literal">host-golang-package</code> macro.
Host packages built by <code class="literal">host-golang-package</code> macro should depend on
BR2_PACKAGE_HOST_GO_HOST_ARCH_SUPPORTS.</p><p>Just like the generic infrastructure, the Go infrastructure works
by defining a number of variables before calling the <code class="literal">golang-package</code>.</p><p>All the package metadata information variables that exist in the
<a class="link" href="ch18.html#generic-package-reference" title="18.6.2. generic-package reference">generic package infrastructure</a> also
exist in the Go infrastructure: <code class="literal">FOO_VERSION</code>, <code class="literal">FOO_SOURCE</code>,
<code class="literal">FOO_PATCH</code>, <code class="literal">FOO_SITE</code>, <code class="literal">FOO_SUBDIR</code>, <code class="literal">FOO_DEPENDENCIES</code>,
<code class="literal">FOO_LICENSE</code>, <code class="literal">FOO_LICENSE_FILES</code>, <code class="literal">FOO_INSTALL_STAGING</code>, etc.</p><p>Note that it is not necessary to add <code class="literal">host-go</code> in the
<code class="literal">FOO_DEPENDENCIES</code> variable of a package, since this basic dependency
is automatically added as needed by the Go package infrastructure.</p><p>A few additional variables, specific to the Go infrastructure, can
optionally be defined, depending on the package’s needs. Many of them
are only useful in very specific cases, typical packages will
therefore only use a few of them, or none.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The package must specify its Go module name in the <code class="literal">FOO_GOMOD</code>
  variable. If not specified, it defaults to
  <code class="literal">URL-domain/1st-part-of-URL/2nd-part-of-URL</code>, e.g <code class="literal">FOO_GOMOD</code> will
  take the value <code class="literal">github.com/bar/foo</code> for a package that specifies
  <code class="literal">FOO_SITE = $(call github,bar,foo,$(FOO_VERSION))</code>. The Go package
  infrastructure will automatically generate a minimal <code class="literal">go.mod</code> file
  in the package source tree if it doesn’t exist.
</li><li class="listitem">
<code class="literal">FOO_LDFLAGS</code> and <code class="literal">FOO_TAGS</code> can be used to pass respectively the
  <code class="literal">LDFLAGS</code> or the <code class="literal">TAGS</code> to the <code class="literal">go</code> build command.
</li><li class="listitem"><p class="simpara">
<code class="literal">FOO_BUILD_TARGETS</code> can be used to pass the list of targets that
  should be built. If <code class="literal">FOO_BUILD_TARGETS</code> is not specified, it
  defaults to <code class="literal">.</code>. We then have two cases:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">FOO_BUILD_TARGETS</code> is <code class="literal">.</code>. In this case, we assume only one binary
   will be produced, and that by default we name it after the package
   name. If that is not appropriate, the name of the produced binary
   can be overridden using <code class="literal">FOO_BIN_NAME</code>.
</li><li class="listitem">
<code class="literal">FOO_BUILD_TARGETS</code> is not <code class="literal">.</code>. In this case, we iterate over the
   values to build each target, and for each produced a binary that is
   the non-directory component of the target. For example if
   <code class="literal">FOO_BUILD_TARGETS = cmd/docker cmd/dockerd</code> the binaries produced
   are <code class="literal">docker</code> and <code class="literal">dockerd</code>.
</li></ul></div></li><li class="listitem">
<code class="literal">FOO_INSTALL_BINS</code> can be used to pass the list of binaries that
  should be installed in <code class="literal">/usr/bin</code> on the target. If
  <code class="literal">FOO_INSTALL_BINS</code> is not specified, it defaults to the lower-case
  name of package.
</li></ul></div><p>With the Go infrastructure, all the steps required to build and
install the packages are already defined, and they generally work well
for most Go-based packages. However, when required, it is still
possible to customize what is done in any particular step:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
By adding a post-operation hook (after extract, patch, configure,
  build or install). See <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for details.
</li><li class="listitem">
By overriding one of the steps. For example, even if the Go
  infrastructure is used, if the package <code class="literal">.mk</code> file defines its own
  <code class="literal">FOO_BUILD_CMDS</code> variable, it will be used instead of the default Go
  one. However, using this method should be restricted to very
  specific cases. Do not use it in the general case.
</li></ul></div><p>A Go package can depend on other Go modules, listed in its <code class="literal">go.mod</code>
file. Buildroot automatically takes care of downloading such
dependencies as part of the download step of packages that use the
<code class="literal">golang-package</code> infrastructure. Such dependencies are then kept
together with the package source code in the tarball cached in
Buildroot’s <code class="literal">DL_DIR</code>, and therefore the hash of the package’s tarball
includes such dependencies.</p><p>This mechanism ensures that any change in the dependencies will be
detected, and allows the build to be performed completely offline.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_qmake_based_packages"></a>18.19. Infrastructure for QMake-based packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="qmake-package-tutorial"></a>18.19.1. <code class="literal">qmake-package</code> tutorial</h3></div></div></div><p>First, let’s see how to write a <code class="literal">.mk</code> file for a QMake-based package, with
an example :</p><pre class="screen">01: ################################################################################
02: #
03: # libfoo
04: #
05: ################################################################################
06:
07: LIBFOO_VERSION = 1.0
08: LIBFOO_SOURCE = libfoo-$(LIBFOO_VERSION).tar.gz
09: LIBFOO_SITE = http://www.foosoftware.org/download
10: LIBFOO_CONF_OPTS = QT_CONFIG+=bar QT_CONFIG-=baz
11: LIBFOO_DEPENDENCIES = bar
12:
13: $(eval $(qmake-package))</pre><p>On line 7, we declare the version of the package.</p><p>On line 8 and 9, we declare the name of the tarball (xz-ed tarball
recommended) and the location of the tarball on the Web. Buildroot
will automatically download the tarball from this location.</p><p>On line 10, we tell Buildroot what options to enable for libfoo.</p><p>On line 11, we tell Buildroot the dependencies of libfoo.</p><p>Finally, on line line 13, we invoke the <code class="literal">qmake-package</code>
macro that generates all the Makefile rules that actually allows the
package to be built.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="qmake-package-reference"></a>18.19.2. <code class="literal">qmake-package</code> reference</h3></div></div></div><p>The main macro of the QMake package infrastructure is <code class="literal">qmake-package</code>.
It is similar to the <code class="literal">generic-package</code> macro.</p><p>Just like the generic infrastructure, the QMake infrastructure works
by defining a number of variables before calling the <code class="literal">qmake-package</code>
macro.</p><p>First, all the package metadata information variables that exist in
the generic infrastructure also exist in the QMake infrastructure:
<code class="literal">LIBFOO_VERSION</code>, <code class="literal">LIBFOO_SOURCE</code>, <code class="literal">LIBFOO_PATCH</code>, <code class="literal">LIBFOO_SITE</code>,
<code class="literal">LIBFOO_SUBDIR</code>, <code class="literal">LIBFOO_DEPENDENCIES</code>, <code class="literal">LIBFOO_INSTALL_STAGING</code>,
<code class="literal">LIBFOO_INSTALL_TARGET</code>.</p><p>An additional variable, specific to the QMake infrastructure, can
also be defined.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LIBFOO_CONF_ENV</code>, to specify additional environment variables to
  pass to the <code class="literal">qmake</code> script for the configuration step. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_CONF_OPTS</code>, to specify additional options to pass to the
  <code class="literal">qmake</code> script for the configuration step. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE_ENV</code>, to specify additional environment variables to the
  <code class="literal">make</code> command during the build and install steps. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_MAKE_OPTS</code>, to specify additional targets to pass to the
  <code class="literal">make</code> command during the build step. By default, empty.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_STAGING_OPTS</code>, to specify additional targets to pass
  to the <code class="literal">make</code> command during the staging installation step. By default,
  <code class="literal">install</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_INSTALL_TARGET_OPTS</code>, to specify additional targets to pass
  to the <code class="literal">make</code> command during the target installation step. By default,
  <code class="literal">install</code>.
</li><li class="listitem">
<code class="literal">LIBFOO_SYNC_QT_HEADERS</code>, to run syncqt.pl before qmake. Some packages
  need this to have a properly populated include directory before
  running the build.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_packages_building_kernel_modules"></a>18.20. Infrastructure for packages building kernel modules</h2></div></div></div><p>Buildroot offers a helper infrastructure to make it easy to write packages that
build and install Linux kernel modules. Some packages only contain a kernel
module, other packages contain programs and libraries in addition to kernel
modules. Buildroot’s helper infrastructure supports either case.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="kernel-module-tutorial"></a>18.20.1. <code class="literal">kernel-module</code> tutorial</h3></div></div></div><p>Let’s start with an example on how to prepare a simple package that only
builds a kernel module, and no other component:</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: FOO_VERSION = 1.2.3
08: FOO_SOURCE = foo-$(FOO_VERSION).tar.xz
09: FOO_SITE = http://www.foosoftware.org/download
10: FOO_LICENSE = GPL-2.0
11: FOO_LICENSE_FILES = COPYING
12:
13: $(eval $(kernel-module))
14: $(eval $(generic-package))</pre><p>Lines 7-11 define the usual meta-data to specify the version, archive name,
remote URI where to find the package source, licensing information.</p><p>On line 13, we invoke the <code class="literal">kernel-module</code> helper infrastructure, that
generates all the appropriate Makefile rules and variables to build
that kernel module.</p><p>Finally, on line 14, we invoke the
<a class="link" href="ch18.html#generic-package-tutorial" title="18.6.1. generic-package tutorial"><code class="literal">generic-package</code> infrastructure</a>.</p><p>The dependency on <code class="literal">linux</code> is automatically added, so it is not needed to
specify it in <code class="literal">FOO_DEPENDENCIES</code>.</p><p>What you may have noticed is that, unlike other package infrastructures,
we explicitly invoke a second infrastructure. This allows a package to
build a kernel module, but also, if needed, use any one of other package
infrastructures to build normal userland components (libraries,
executables…). Using the <code class="literal">kernel-module</code> infrastructure on its own is
not sufficient; another package infrastructure <span class="strong"><strong>must</strong></span> be used.</p><p>Let’s look at a more complex example:</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: FOO_VERSION = 1.2.3
08: FOO_SOURCE = foo-$(FOO_VERSION).tar.xz
09: FOO_SITE = http://www.foosoftware.org/download
10: FOO_LICENSE = GPL-2.0
11: FOO_LICENSE_FILES = COPYING
12:
13: FOO_MODULE_SUBDIRS = driver/base
14: FOO_MODULE_MAKE_OPTS = KVERSION=$(LINUX_VERSION_PROBED)
15:
16: ifeq ($(BR2_PACKAGE_LIBBAR),y)
17: FOO_DEPENDENCIES += libbar
18: FOO_CONF_OPTS += --enable-bar
19: FOO_MODULE_SUBDIRS += driver/bar
20: else
21: FOO_CONF_OPTS += --disable-bar
22: endif
23:
24: $(eval $(kernel-module))
26: $(eval $(autotools-package))</pre><p>Here, we see that we have an autotools-based package, that also builds
the kernel module located in sub-directory <code class="literal">driver/base</code> and, if libbar
is enabled, the kernel module located in sub-directory <code class="literal">driver/bar</code>, and
defines the variable <code class="literal">KVERSION</code> to be passed to the Linux buildsystem
when building the module(s).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="kernel-module-reference"></a>18.20.2. <code class="literal">kernel-module</code> reference</h3></div></div></div><p>The main macro for the  kernel module infrastructure is <code class="literal">kernel-module</code>.
Unlike other package infrastructures, it is not stand-alone, and requires
any of the other <code class="literal">*-package</code> macros be called after it.</p><p>The <code class="literal">kernel-module</code> macro defines post-build and post-target-install
hooks to build the kernel modules. If the package’s <code class="literal">.mk</code> needs access
to the built kernel modules, it should do so in a post-build hook,
<span class="strong"><strong>registered after</strong></span> the call to <code class="literal">kernel-module</code>. Similarly, if the
package’s <code class="literal">.mk</code> needs access to the kernel module after it has been
installed, it should do so in a post-install hook, <span class="strong"><strong>registered after</strong></span>
the call to <code class="literal">kernel-module</code>. Here’s an example:</p><pre class="screen">$(eval $(kernel-module))

define FOO_DO_STUFF_WITH_KERNEL_MODULE
    # Do something with it...
endef
FOO_POST_BUILD_HOOKS += FOO_DO_STUFF_WITH_KERNEL_MODULE

$(eval $(generic-package))</pre><p>Finally, unlike the other package infrastructures, there is no
<code class="literal">host-kernel-module</code> variant to build a host kernel module.</p><p>The following additional variables can optionally be defined to further
configure the build of the kernel module:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_MODULE_SUBDIRS</code> may be set to one or more sub-directories (relative
  to the package source top-directory) where the kernel module sources are.
  If empty or not set, the sources for the kernel module(s) are considered
  to be located at the top of the package source tree.
</li><li class="listitem">
<code class="literal">FOO_MODULE_MAKE_OPTS</code> may be set to contain extra variable definitions
  to pass to the Linux buildsystem.
</li></ul></div><p><a id="kernel-variables"></a>You may also reference (but you may <span class="strong"><strong>not</strong></span> set!) those variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LINUX_DIR</code> contains the path to where the Linux kernel has been
   extracted and built.
</li><li class="listitem">
<code class="literal">LINUX_VERSION</code> contains the version string as configured by the user.
</li><li class="listitem">
<code class="literal">LINUX_VERSION_PROBED</code> contains the real version string of the kernel,
   retrieved with running <code class="literal">make -C $(LINUX_DIR) kernelrelease</code>
</li><li class="listitem">
<code class="literal">KERNEL_ARCH</code> contains the name of the current architecture, like <code class="literal">arm</code>,
   <code class="literal">mips</code>…
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_infrastructure_for_asciidoc_documents"></a>18.21. Infrastructure for asciidoc documents</h2></div></div></div><p><a id="asciidoc-documents-tutorial"></a>The Buildroot manual, which you are currently reading, is entirely written
using the <a class="ulink" href="http://asciidoc.org/" target="_top">AsciiDoc</a> mark-up syntax. The manual is then
rendered to many formats:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
html
</li><li class="listitem">
split-html
</li><li class="listitem">
pdf
</li><li class="listitem">
epub
</li><li class="listitem">
text
</li></ul></div><p>Although Buildroot only contains one document written in AsciiDoc, there
is, as for packages, an infrastructure for rendering documents using the
AsciiDoc syntax.</p><p>Also as for packages, the AsciiDoc infrastructure is available from a
<a class="link" href="ch09.html#outside-br-custom" title="9.2. Keeping customizations outside of Buildroot">br2-external tree</a>. This allows documentation for
a br2-external tree to match the Buildroot documentation, as it will be
rendered to the same formats and use the same layout and theme.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_literal_asciidoc_document_literal_tutorial"></a>18.21.1. <code class="literal">asciidoc-document</code> tutorial</h3></div></div></div><p>Whereas package infrastructures are suffixed with <code class="literal">-package</code>, the document
infrastructures are suffixed with <code class="literal">-document</code>. So, the AsciiDoc infrastructure
is named <code class="literal">asciidoc-document</code>.</p><p>Here is an example to render a simple AsciiDoc document.</p><pre class="screen">01: ################################################################################
02: #
03: # foo-document
04: #
05: ################################################################################
06:
07: FOO_SOURCES = $(sort $(wildcard $(FOO_DOCDIR)/*))
08: $(eval $(call asciidoc-document))</pre><p>On line 7, the Makefile declares what the sources of the document are.
Currently, it is expected that the document’s sources are only local;
Buildroot will not attempt to download anything to render a document.
Thus, you must indicate where the sources are. Usually, the string
above is sufficient for a document with no sub-directory structure.</p><p>On line 8, we call the <code class="literal">asciidoc-document</code> function, which generates all
the Makefile code necessary to render the document.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_literal_asciidoc_document_literal_reference"></a>18.21.2. <code class="literal">asciidoc-document</code> reference</h3></div></div></div><p>The list of variables that can be set in a <code class="literal">.mk</code> file to give metadata
information is (assuming the document name is <code class="literal">foo</code>) :</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_SOURCES</code>, mandatory, defines the source files for the document.
</li><li class="listitem">
<code class="literal">FOO_RESOURCES</code>, optional, may contain a space-separated list of paths
  to one or more directories containing so-called resources (like CSS or
  images). By default, empty.
</li><li class="listitem">
<code class="literal">FOO_DEPENDENCIES</code>, optional, the list of packages (most probably,
  host-packages) that must be built before building this document.
</li></ul></div><p>There are also additional hooks (see <a class="xref" href="ch18.html#hooks" title="18.23. Hooks available in the various build steps">Section 18.23, “Hooks available in the various build steps”</a> for general information
on hooks), that a document may set to define extra actions to be done at
various steps:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FOO_POST_RSYNC_HOOKS</code> to run additional commands after the sources
  have been copied by Buildroot. This can for example be used to
  generate part of the manual with information extracted from the
  tree. As an example, Buildroot uses this hook to generate the tables
  in the appendices.
</li><li class="listitem">
<code class="literal">FOO_CHECK_DEPENDENCIES_HOOKS</code> to run additional tests on required
  components to generate the document. In AsciiDoc, it is possible to
  call filters, that is, programs that will parse an AsciiDoc block and
  render it appropriately (e.g. <a class="ulink" href="http://ditaa.sourceforge.net/" target="_top">ditaa</a> or
  <a class="ulink" href="https://pythonhosted.org/aafigure/" target="_top">aafigure</a>).
</li><li class="listitem">
<code class="literal">FOO_CHECK_DEPENDENCIES_&lt;FMT&gt;_HOOKS</code>, to run additional tests for
  the specified format <code class="literal">&lt;FMT&gt;</code> (see the list of rendered formats, above).
</li></ul></div><p>Buildroot sets the following variable that can be used in the definitions
above:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">$(FOO_DOCDIR)</code>, similar to <code class="literal">$(FOO_PKGDIR)</code>, contains the path to the
  directory containing <code class="literal">foo.mk</code>. It can be used to refer to the document
  sources, and can be used in the hooks, especially the post-rsync hook
  if parts of the documentation needs to be generated.
</li><li class="listitem">
<code class="literal">$(@D)</code>, as for traditional packages, contains the path to the directory
  where the document will be copied and built.
</li></ul></div><p>Here is a complete example that uses all variables and all hooks:</p><pre class="screen">01: ################################################################################
02: #
03: # foo-document
04: #
05: ################################################################################
06:
07: FOO_SOURCES = $(sort $(wildcard $(FOO_DOCDIR)/*))
08: FOO_RESOURCES = $(sort $(wildcard $(FOO_DOCDIR)/ressources))
09:
10: define FOO_GEN_EXTRA_DOC
11:     /path/to/generate-script --outdir=$(@D)
12: endef
13: FOO_POST_RSYNC_HOOKS += FOO_GEN_EXTRA_DOC
14:
15: define FOO_CHECK_MY_PROG
16:     if ! which my-prog &gt;/dev/null 2&gt;&amp;1; then \
17:         echo "You need my-prog to generate the foo document"; \
18:         exit 1; \
19:     fi
20: endef
21: FOO_CHECK_DEPENDENCIES_HOOKS += FOO_CHECK_MY_PROG
22:
23: define FOO_CHECK_MY_OTHER_PROG
24:     if ! which my-other-prog &gt;/dev/null 2&gt;&amp;1; then \
25:         echo "You need my-other-prog to generate the foo document as PDF"; \
26:         exit 1; \
27:     fi
28: endef
29: FOO_CHECK_DEPENDENCIES_PDF_HOOKS += FOO_CHECK_MY_OTHER_PROG
30:
31: $(eval $(call asciidoc-document))</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="linux-kernel-specific-infra"></a>18.22. Infrastructure specific to the Linux kernel package</h2></div></div></div><p>The Linux kernel package can use some specific infrastructures based on package
hooks for building Linux kernel tools or/and building Linux kernel extensions.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="linux-kernel-tools"></a>18.22.1. linux-kernel-tools</h3></div></div></div><p>Buildroot offers a helper infrastructure to build some userspace tools
for the target available within the Linux kernel sources. Since their
source code is part of the kernel source code, a special package,
<code class="literal">linux-tools</code>, exists and re-uses the sources of the Linux kernel that
runs on the target.</p><p>Let’s look at an example of a Linux tool. For a new Linux tool named
<code class="literal">foo</code>, create a new menu entry in the existing
<code class="literal">package/linux-tools/Config.in</code>.  This file will contain the option
descriptions related to each kernel tool that will be used and
displayed in the configuration tool. It would basically look like:</p><pre class="screen">01: config BR2_PACKAGE_LINUX_TOOLS_FOO
02:     bool "foo"
03:     select BR2_PACKAGE_LINUX_TOOLS
04:     help
05:       This is a comment that explains what foo kernel tool is.
06:
07:       http://foosoftware.org/foo/</pre><p>The name of the option starts with the prefix <code class="literal">BR2_PACKAGE_LINUX_TOOLS_</code>,
followed by the uppercase name of the tool (like is done for packages).</p><p><strong>Note. </strong>Unlike other packages, the <code class="literal">linux-tools</code> package options appear in the
<code class="literal">linux</code> kernel menu, under the <code class="literal">Linux Kernel Tools</code> sub-menu, not under
the <code class="literal">Target packages</code> main menu.</p><p>Then for each linux tool, add a new <code class="literal">.mk.in</code> file named
<code class="literal">package/linux-tools/linux-tool-foo.mk.in</code>. It would basically look like:</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: LINUX_TOOLS += foo
08:
09: FOO_DEPENDENCIES = libbbb
10:
11: define FOO_BUILD_CMDS
12:     $(TARGET_MAKE_ENV) $(MAKE) -C $(LINUX_DIR)/tools foo
13: endef
14:
15: define FOO_INSTALL_STAGING_CMDS
16:     $(TARGET_MAKE_ENV) $(MAKE) -C $(LINUX_DIR)/tools \
17:             DESTDIR=$(STAGING_DIR) \
18:             foo_install
19: endef
20:
21: define FOO_INSTALL_TARGET_CMDS
22:     $(TARGET_MAKE_ENV) $(MAKE) -C $(LINUX_DIR)/tools \
23:             DESTDIR=$(TARGET_DIR) \
24:             foo_install
25: endef</pre><p>On line 7, we register the Linux tool <code class="literal">foo</code> to the list of available
Linux tools.</p><p>On line 9, we specify the list of dependencies this tool relies on. These
dependencies are added to the Linux package dependencies list only when the
<code class="literal">foo</code> tool is selected.</p><p>The rest of the Makefile, lines 11-25 defines what should be done at the
different steps of the Linux tool build process like for a
<a class="link" href="ch18.html#generic-package-tutorial" title="18.6.1. generic-package tutorial"><code class="literal">generic package</code></a>. They will actually be
used only when the <code class="literal">foo</code> tool is selected. The only supported commands are
<code class="literal">_BUILD_CMDS</code>, <code class="literal">_INSTALL_STAGING_CMDS</code> and <code class="literal">_INSTALL_TARGET_CMDS</code>.</p><p><strong>Note. </strong>One <span class="strong"><strong>must not</strong></span> call <code class="literal">$(eval $(generic-package))</code> or any other
package infrastructure! Linux tools are not packages by themselves,
they are part of the <code class="literal">linux-tools</code> package.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="linux-kernel-ext"></a>18.22.2. linux-kernel-extensions</h3></div></div></div><p>Some packages provide new features that require the Linux kernel tree
to be modified. This can be in the form of patches to be applied on
the kernel tree, or in the form of new files to be added to the
tree. The Buildroot’s Linux kernel extensions infrastructure provides
a simple solution to automatically do this, just after the kernel
sources are extracted and before the kernel patches are
applied. Examples of extensions packaged using this mechanism are the
real-time extensions Xenomai and RTAI, as well as the set of
out-of-tree LCD screens drivers <code class="literal">fbtft</code>.</p><p>Let’s look at an example on how to add a new Linux extension <code class="literal">foo</code>.</p><p>First, create the package <code class="literal">foo</code> that provides the extension: this
package is a standard package; see the previous chapters on how to
create such a package. This package is in charge of downloading the
sources archive, checking the hash, defining the licence informations
and building user space tools if any.</p><p>Then create the <span class="emphasis"><em>Linux extension</em></span> proper: create a new menu entry in
the existing <code class="literal">linux/Config.ext.in</code>. This file contains the option
descriptions related to each kernel extension that will be used and
displayed in the configuration tool. It would basically look like:</p><pre class="screen">01: config BR2_LINUX_KERNEL_EXT_FOO
02:     bool "foo"
03:     help
04:       This is a comment that explains what foo kernel extension is.
05:
06:       http://foosoftware.org/foo/</pre><p>Then for each linux extension, add a new <code class="literal">.mk</code> file named
<code class="literal">linux/linux-ext-foo.mk</code>. It should basically contain:</p><pre class="screen">01: ################################################################################
02: #
03: # foo
04: #
05: ################################################################################
06:
07: LINUX_EXTENSIONS += foo
08:
09: define FOO_PREPARE_KERNEL
10:     $(FOO_DIR)/prepare-kernel-tree.sh --linux-dir=$(@D)
11: endef</pre><p>On line 7, we add the Linux extension <code class="literal">foo</code> to the list of available
Linux extensions.</p><p>On line 9-11, we define what should be done by the extension to modify
the Linux kernel tree; this is specific to the linux extension and can
use the variables defined by the <code class="literal">foo</code> package, like: <code class="literal">$(FOO_DIR)</code> or
<code class="literal">$(FOO_VERSION)</code>… as well as all the Linux variables, like:
<code class="literal">$(LINUX_VERSION)</code> or <code class="literal">$(LINUX_VERSION_PROBED)</code>, <code class="literal">$(KERNEL_ARCH)</code>…
See the <a class="link" href="ch18.html#kernel-variables">definition of those kernel variables</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="hooks"></a>18.23. Hooks available in the various build steps</h2></div></div></div><p>The generic infrastructure (and as a result also the derived autotools
and cmake infrastructures) allow packages to specify hooks.
These define further actions to perform after existing steps.
Most hooks aren’t really useful for generic packages, since the <code class="literal">.mk</code>
file already has full control over the actions performed in each step
of the package construction.</p><p>The following hook points are available:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">LIBFOO_PRE_DOWNLOAD_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_DOWNLOAD_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_EXTRACT_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_EXTRACT_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_RSYNC_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_RSYNC_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_PATCH_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_PATCH_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_CONFIGURE_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_CONFIGURE_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_BUILD_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_BUILD_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_INSTALL_HOOKS</code> (for host packages only)
</li><li class="listitem">
<code class="literal">LIBFOO_POST_INSTALL_HOOKS</code> (for host packages only)
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_INSTALL_STAGING_HOOKS</code> (for target packages only)
</li><li class="listitem">
<code class="literal">LIBFOO_POST_INSTALL_STAGING_HOOKS</code> (for target packages only)
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_INSTALL_TARGET_HOOKS</code> (for target packages only)
</li><li class="listitem">
<code class="literal">LIBFOO_POST_INSTALL_TARGET_HOOKS</code> (for target packages only)
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_INSTALL_IMAGES_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_INSTALL_IMAGES_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_PRE_LEGAL_INFO_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_POST_LEGAL_INFO_HOOKS</code>
</li><li class="listitem">
<code class="literal">LIBFOO_TARGET_FINALIZE_HOOKS</code>
</li></ul></div><p>These variables are <span class="emphasis"><em>lists</em></span> of variable names containing actions to be
performed at this hook point. This allows several hooks to be
registered at a given hook point. Here is an example:</p><pre class="screen">define LIBFOO_POST_PATCH_FIXUP
        action1
        action2
endef

LIBFOO_POST_PATCH_HOOKS += LIBFOO_POST_PATCH_FIXUP</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="hooks-rsync"></a>18.23.1. Using the <code class="literal">POST_RSYNC</code> hook</h3></div></div></div><p>The <code class="literal">POST_RSYNC</code> hook is run only for packages that use a local source,
either through the <code class="literal">local</code> site method or the <code class="literal">OVERRIDE_SRCDIR</code>
mechanism. In this case, package sources are copied using <code class="literal">rsync</code> from
the local location into the buildroot build directory. The <code class="literal">rsync</code>
command does not copy all files from the source directory, though.
Files belonging to a version control system, like the directories
<code class="literal">.git</code>, <code class="literal">.hg</code>, etc. are not copied. For most packages this is
sufficient, but a given package can perform additional actions using
the <code class="literal">POST_RSYNC</code> hook.</p><p>In principle, the hook can contain any command you want. One specific
use case, though, is the intentional copying of the version control
directory using <code class="literal">rsync</code>. The <code class="literal">rsync</code> command you use in the hook can, among
others, use the following variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">$(SRCDIR)</code>: the path to the overridden source directory
</li><li class="listitem">
<code class="literal">$(@D)</code>: the path to the build directory
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_target_finalize_hook"></a>18.23.2. Target-finalize hook</h3></div></div></div><p>Packages may also register hooks in <code class="literal">LIBFOO_TARGET_FINALIZE_HOOKS</code>.
These hooks are run after all packages are built, but before the
filesystem images are generated. They are seldom used, and your
package probably do not need them.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_gettext_integration_and_interaction_with_packages"></a>18.24. Gettext integration and interaction with packages</h2></div></div></div><p>Many packages that support internationalization use the gettext
library. Dependencies for this library are fairly complicated and
therefore, deserve some explanation.</p><p>The <span class="emphasis"><em>glibc</em></span> C library integrates a full-blown implementation of
<span class="emphasis"><em>gettext</em></span>, supporting translation. Native Language Support is
therefore built-in in <span class="emphasis"><em>glibc</em></span>.</p><p>On the other hand, the <span class="emphasis"><em>uClibc</em></span> and <span class="emphasis"><em>musl</em></span> C libraries only provide a
stub implementation of the gettext functionality, which allows to
compile libraries and programs using gettext functions, but without
providing the translation capabilities of a full-blown gettext
implementation. With such C libraries, if real Native Language Support
is necessary, it can be provided by the <code class="literal">libintl</code> library of the
<code class="literal">gettext</code> package.</p><p>Due to this, and in order to make sure that Native Language Support is
properly handled, packages in Buildroot that can use NLS support
should:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Ensure NLS support is enabled when <code class="literal">BR2_SYSTEM_ENABLE_NLS=y</code>. This
   is done automatically for <span class="emphasis"><em>autotools</em></span> packages and therefore should
   only be done for packages using other package infrastructures.
</li><li class="listitem">
Add <code class="literal">$(TARGET_NLS_DEPENDENCIES)</code> to the package
   <code class="literal">&lt;pkg&gt;_DEPENDENCIES</code> variable. This addition should be done
   unconditionally: the value of this variable is automatically
   adjusted by the core infrastructure to contain the relevant list of
   packages. If NLS support is disabled, this variable is empty. If
   NLS support is enabled, this variable contains <code class="literal">host-gettext</code> so
   that tools needed to compile translation files are available on the
   host. In addition, if <span class="emphasis"><em>uClibc</em></span> or <span class="emphasis"><em>musl</em></span> are used, this variable
   also contains <code class="literal">gettext</code> in order to get the full-blown <span class="emphasis"><em>gettext</em></span>
   implementation.
</li><li class="listitem">
If needed, add <code class="literal">$(TARGET_NLS_LIBS)</code> to the linker flags, so that
   the package gets linked with <code class="literal">libintl</code>. This is generally not
   needed with <span class="emphasis"><em>autotools</em></span> packages as they usually detect
   automatically that they should link with <code class="literal">libintl</code>. However,
   packages using other build systems, or problematic autotools-based
   packages may need this. <code class="literal">$(TARGET_NLS_LIBS)</code> should be added
   unconditionally to the linker flags, as the core automatically
   makes it empty or defined to <code class="literal">-lintl</code> depending on the
   configuration.
</li></ol></div><p>No changes should be made to the <code class="literal">Config.in</code> file to support NLS.</p><p>Finally, certain packages need some gettext utilities on the target,
such as the <code class="literal">gettext</code> program itself, which allows to retrieve
translated strings, from the command line. In such a case, the package
should:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
use <code class="literal">select BR2_PACKAGE_GETTEXT</code> in their <code class="literal">Config.in</code> file,
  indicating in a comment above that it’s a runtime dependency only.
</li><li class="listitem">
not add any <code class="literal">gettext</code> dependency in the <code class="literal">DEPENDENCIES</code> variable of
  their <code class="literal">.mk</code> file.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_tips_and_tricks"></a>18.25. Tips and tricks</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="package-name-variable-relation"></a>18.25.1. Package name, config entry name and makefile variable relationship</h3></div></div></div><p>In Buildroot, there is some relationship between:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the <span class="emphasis"><em>package name</em></span>, which is the package directory name (and the
  name of the <code class="literal">*.mk</code> file);
</li><li class="listitem">
the config entry name that is declared in the <code class="literal">Config.in</code> file;
</li><li class="listitem">
the makefile variable prefix.
</li></ul></div><p>It is mandatory to maintain consistency between these elements,
using the following rules:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the package directory and the <code class="literal">*.mk</code> name are the <span class="emphasis"><em>package name</em></span>
  itself (e.g.: <code class="literal">package/foo-bar_boo/foo-bar_boo.mk</code>);
</li><li class="listitem">
the <span class="emphasis"><em>make</em></span> target name is the <span class="emphasis"><em>package name</em></span> itself (e.g.:
  <code class="literal">foo-bar_boo</code>);
</li><li class="listitem">
the config entry is the upper case <span class="emphasis"><em>package name</em></span> with <code class="literal">.</code> and <code class="literal">-</code>
  characters substituted with <code class="literal">_</code>, prefixed with <code class="literal">BR2_PACKAGE_</code> (e.g.:
  <code class="literal">BR2_PACKAGE_FOO_BAR_BOO</code>);
</li><li class="listitem">
the <code class="literal">*.mk</code> file variable prefix is the upper case <span class="emphasis"><em>package name</em></span>
  with <code class="literal">.</code> and <code class="literal">-</code> characters substituted with <code class="literal">_</code> (e.g.:
  <code class="literal">FOO_BAR_BOO_VERSION</code>).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="check-package"></a>18.25.2. How to check the coding style</h3></div></div></div><p>Buildroot provides a script in <code class="literal">utils/check-package</code> that checks new or
changed files for coding style. It is not a complete language validator,
but it catches many common mistakes. It is meant to run in the actual
files you created or modified, before creating the patch for submission.</p><p>This script can be used for packages, filesystem makefiles, Config.in
files, etc. It does not check the files defining the package
infrastructures and some other files containing similar common code.</p><p>To use it, run the <code class="literal">check-package</code> script, by telling which files you
created or changed:</p><pre class="screen">$ ./utils/check-package package/new-package/*</pre><p>If you have the <code class="literal">utils</code> directory in your path you can also run:</p><pre class="screen">$ cd package/new-package/
$ check-package *</pre><p>The tool can also be used for packages in a br2-external:</p><pre class="screen">$ check-package -b /path/to/br2-ext-tree/package/my-package/*</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="testing-package"></a>18.25.3. How to test your package</h3></div></div></div><p>Once you have added your new package, it is important that you test it
under various conditions: does it build for all architectures? Does it
build with the different C libraries? Does it need threads, NPTL? And
so on…</p><p>Buildroot runs <a class="ulink" href="http://autobuild.buildroot.org/" target="_top">autobuilders</a> which
continuously test random configurations. However, these only build the
<code class="literal">master</code> branch of the git tree, and your new fancy package is not yet
there.</p><p>Buildroot provides a script in <code class="literal">utils/test-pkg</code> that uses the same base
configurations as used by the autobuilders so you can test your package
in the same conditions.</p><p>First, create a config snippet that contains all the necessary options
needed to enable your package, but without any architecture or toolchain
option. For example, let’s create a config snippet that just enables
<code class="literal">libcurl</code>, without any TLS backend:</p><pre class="screen">$ cat libcurl.config
BR2_PACKAGE_LIBCURL=y</pre><p>If your package needs more configuration options, you can add them to the
config snippet. For example, here’s how you would test <code class="literal">libcurl</code> with
<code class="literal">openssl</code> as a TLS backend and the <code class="literal">curl</code> program:</p><pre class="screen">$ cat libcurl.config
BR2_PACKAGE_LIBCURL=y
BR2_PACKAGE_LIBCURL_CURL=y
BR2_PACKAGE_OPENSSL=y</pre><p>Then run the <code class="literal">test-pkg</code> script, by telling it what config snippet to use
and what package to test:</p><pre class="screen">$ ./utils/test-pkg -c libcurl.config -p libcurl</pre><p>By default, <code class="literal">test-pkg</code> will build your package against a subset of the
toolchains used by the autobuilders, which has been selected by the
Buildroot developers as being the most useful and representative
subset. If you want to test all toolchains, pass the <code class="literal">-a</code> option. Note
that in any case, internal toolchains are excluded as they take too
long to build.</p><p>The output lists all toolchains that are tested and the corresponding
result (excerpt, results are fake):</p><pre class="screen">$ ./utils/test-pkg -c libcurl.config -p libcurl
                armv5-ctng-linux-gnueabi [ 1/11]: OK
              armv7-ctng-linux-gnueabihf [ 2/11]: OK
                        br-aarch64-glibc [ 3/11]: SKIPPED
                           br-arcle-hs38 [ 4/11]: SKIPPED
                            br-arm-basic [ 5/11]: FAILED
                  br-arm-cortex-a9-glibc [ 6/11]: OK
                   br-arm-cortex-a9-musl [ 7/11]: FAILED
                   br-arm-cortex-m4-full [ 8/11]: OK
                             br-arm-full [ 9/11]: OK
                    br-arm-full-nothread [10/11]: FAILED
                      br-arm-full-static [11/11]: OK
11 builds, 2 skipped, 2 build failed, 1 legal-info failed</pre><p>The results mean:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">OK</code>: the build was successful.
</li><li class="listitem">
<code class="literal">SKIPPED</code>: one or more configuration options listed in the config
  snippet were not present in the final configuration. This is due to
  options having dependencies not satisfied by the toolchain, such as
  for example a package that <code class="literal">depends on BR2_USE_MMU</code> with a noMMU
  toolchain. The missing options are reported in <code class="literal">missing.config</code> in
  the output build directory (<code class="literal">~/br-test-pkg/TOOLCHAIN_NAME/</code> by
  default).
</li><li class="listitem"><p class="simpara">
<code class="literal">FAILED</code>: the build failed. Inspect the <code class="literal">logfile</code> file in the output
  build  directory to see what went wrong:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
the actual build failed,
</li><li class="listitem">
the legal-info failed,
</li><li class="listitem">
one of the preliminary steps (downloading the config file, applying
   the configuration, running <code class="literal">dirclean</code> for the package) failed.
</li></ul></div></li></ul></div><p>When there are failures, you can just re-run the script with the same
options (after you fixed your package); the script will attempt to
re-build the package specified with <code class="literal">-p</code> for all toolchains, without
the need to re-build all the dependencies of that package.</p><p>The <code class="literal">test-pkg</code> script accepts a few options, for which you can get some
help by running:</p><pre class="screen">$ ./utils/test-pkg -h</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="github-download-url"></a>18.25.4. How to add a package from GitHub</h3></div></div></div><p>Packages on GitHub often don’t have a download area with release tarballs.
However, it is possible to download tarballs directly from the repository
on GitHub. As GitHub is known to have changed download mechanisms in the
past, the <span class="emphasis"><em>github</em></span> helper function should be used as shown below.</p><pre class="screen"># Use a tag or a full commit ID
FOO_VERSION = 1.0
FOO_SITE = $(call github,&lt;user&gt;,&lt;package&gt;,v$(FOO_VERSION))</pre><div class="itemizedlist"><p class="title"><strong>Notes</strong></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The FOO_VERSION can either be a tag or a commit ID.
</li><li class="listitem">
The tarball name generated by github matches the default one from
  Buildroot (e.g.: <code class="literal">foo-f6fb6654af62045239caed5950bc6c7971965e60.tar.gz</code>),
  so it is not necessary to specify it in the <code class="literal">.mk</code> file.
</li><li class="listitem">
When using a commit ID as version, you should use the full 40 hex characters.
</li><li class="listitem">
When the tag contains a prefix such as <code class="literal">v</code> in <code class="literal">v1.0</code>, then the
  <code class="literal">VERSION</code> variable should contain just <code class="literal">1.0</code>, and the <code class="literal">v</code> should be
  added directly in the <code class="literal">SITE</code> variable, as illustrated above. This
  ensures that the <code class="literal">VERSION</code> variable value can be used to match
  against <a class="ulink" href="http://www.release-monitoring.org/" target="_top">release-monitoring.org</a>
  results.
</li></ul></div><p>If the package you wish to add does have a release section on GitHub, the
maintainer may have uploaded a release tarball, or the release may just point
to the automatically generated tarball from the git tag. If there is a
release tarball uploaded by the maintainer, we prefer to use that since it
may be slightly different (e.g. it contains a configure script so we don’t
need to do AUTORECONF).</p><p>You can see on the release page if it’s an uploaded tarball or a git tag:</p><div class="informalfigure"><div class="mediaobject"><img src="github_hash_mongrel2.png" alt="github_hash_mongrel2.png" /></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If it looks like the image above then it was uploaded by the
  maintainer and you should use that link (in that example:
  <span class="emphasis"><em>mongrel2-v1.9.2.tar.bz2</em></span>) to specify <code class="literal">FOO_SITE</code>, and not use the
  <span class="emphasis"><em>github</em></span> helper.
</li><li class="listitem">
On the other hand, if there’s is <span class="strong"><strong>only</strong></span> the "Source code" link, then
  it’s an automatically generated tarball and you should use the
  <span class="emphasis"><em>github</em></span> helper function.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="gitlab-download-url"></a>18.25.5. How to add a package from Gitlab</h3></div></div></div><p>In a similar way to the <code class="literal">github</code> macro described in
<a class="xref" href="ch18.html#github-download-url" title="18.25.4. How to add a package from GitHub">Section 18.25.4, “How to add a package from GitHub”</a>, Buildroot also provides the <code class="literal">gitlab</code> macro
to download from Gitlab repositories. It can be used to download
auto-generated tarballs produced by Gitlab, either for specific tags
or commits:</p><pre class="screen"># Use a tag or a full commit ID
FOO_VERSION = 1.0
FOO_SITE = $(call gitlab,&lt;user&gt;,&lt;package&gt;,v$(FOO_VERSION))</pre><p>By default, it will use a <code class="literal">.tar.gz</code> tarball, but Gitlab also provides
<code class="literal">.tar.bz2</code> tarballs, so by adding a <code class="literal">&lt;pkg&gt;_SOURCE</code> variable, this
<code class="literal">.tar.bz2</code> tarball can be used:</p><pre class="screen"># Use a tag or a full commit ID
FOO_VERSION = 1.0
FOO_SITE = $(call gitlab,&lt;user&gt;,&lt;package&gt;,v$(FOO_VERSION))
FOO_SOURCE = foo-$(FOO_VERSION).tar.bz2</pre><p>If there is a specific tarball uploaded by the upstream developers in
<code class="literal">https://gitlab.com/&lt;project&gt;/releases/</code>, do not use this macro, but
rather use directly the link to the tarball.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_conclusion"></a>18.26. Conclusion</h2></div></div></div><p>As you can see, adding a software package to Buildroot is simply a
matter of writing a Makefile using an existing example and modifying it
according to the compilation process required by the package.</p><p>If you package software that might be useful for other people, don’t
forget to send a patch to the Buildroot mailing list (see
<a class="xref" href="ch22.html#submitting-patches" title="22.5. Submitting patches">Section 22.5, “Submitting patches”</a>)!</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch17.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="pt03.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch19.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div></body></html>